<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Checkout - HATOD</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/pages.css">
  
  
  
  </head>
    <style>
        html, body {
            overflow-x: hidden;
            position: relative;
        }
        body {
            margin: 0;
            padding: 0;
        }
        .content-wrapper {
            margin-top: calc(4rem + max(2rem, env(safe-area-inset-top))); /* Push content below fixed header */
            font-size: 0.78em; /* Base font size reduction by 22% */
        }
        /* Reduce font sizes */
        .content-wrapper .text-xs { font-size: calc(0.75rem * 0.78) !important; line-height: calc(1rem * 0.78) !important; }
        .content-wrapper .text-sm { font-size: calc(0.875rem * 0.78) !important; line-height: calc(1.25rem * 0.78) !important; }
        .content-wrapper .text-base { font-size: calc(1rem * 0.78) !important; line-height: calc(1.5rem * 0.78) !important; }
        .content-wrapper .text-lg { font-size: calc(1.125rem * 0.78) !important; line-height: calc(1.75rem * 0.78) !important; }
        .content-wrapper .text-xl { font-size: calc(1.25rem * 0.78) !important; line-height: calc(1.75rem * 0.78) !important; }
        .content-wrapper .text-2xl { font-size: calc(1.5rem * 0.78) !important; line-height: calc(2rem * 0.78) !important; }
        .content-wrapper .text-3xl { font-size: calc(1.875rem * 0.78) !important; line-height: calc(2.25rem * 0.78) !important; }
        /* Reduce spacing - padding */
        .content-wrapper .p-1 { padding: calc(0.25rem * 0.78) !important; }
        .content-wrapper .p-2 { padding: calc(0.5rem * 0.78) !important; }
        .content-wrapper .p-3 { padding: calc(0.75rem * 0.78) !important; }
        .content-wrapper .p-4 { padding: calc(1rem * 0.78) !important; }
        .content-wrapper .p-6 { padding: calc(1.5rem * 0.78) !important; }
        .content-wrapper .p-8 { padding: calc(2rem * 0.78) !important; }
        .content-wrapper .p-12 { padding: calc(3rem * 0.78) !important; }
        .content-wrapper .px-1 { padding-left: calc(0.25rem * 0.78) !important; padding-right: calc(0.25rem * 0.78) !important; }
        .content-wrapper .px-2 { padding-left: calc(0.5rem * 0.78) !important; padding-right: calc(0.5rem * 0.78) !important; }
        .content-wrapper .px-3 { padding-left: calc(0.75rem * 0.78) !important; padding-right: calc(0.75rem * 0.78) !important; }
        .content-wrapper .px-4 { padding-left: calc(1rem * 0.78) !important; padding-right: calc(1rem * 0.78) !important; }
        .content-wrapper .px-6 { padding-left: calc(1.5rem * 0.78) !important; padding-right: calc(1.5rem * 0.78) !important; }
        .content-wrapper .px-8 { padding-left: calc(2rem * 0.78) !important; padding-right: calc(2rem * 0.78) !important; }
        .content-wrapper .py-1 { padding-top: calc(0.25rem * 0.78) !important; padding-bottom: calc(0.25rem * 0.78) !important; }
        .content-wrapper .py-2 { padding-top: calc(0.5rem * 0.78) !important; padding-bottom: calc(0.5rem * 0.78) !important; }
        .content-wrapper .py-3 { padding-top: calc(0.75rem * 0.78) !important; padding-bottom: calc(0.75rem * 0.78) !important; }
        .content-wrapper .py-4 { padding-top: calc(1rem * 0.78) !important; padding-bottom: calc(1rem * 0.78) !important; }
        .content-wrapper .py-6 { padding-top: calc(1.5rem * 0.78) !important; padding-bottom: calc(1.5rem * 0.78) !important; }
        .content-wrapper .py-8 { padding-top: calc(2rem * 0.78) !important; padding-bottom: calc(2rem * 0.78) !important; }
        .content-wrapper .py-12 { padding-top: calc(3rem * 0.78) !important; padding-bottom: calc(3rem * 0.78) !important; }
        .content-wrapper .pt-2 { padding-top: calc(0.5rem * 0.78) !important; }
        .content-wrapper .pt-3 { padding-top: calc(0.75rem * 0.78) !important; }
        .content-wrapper .pt-4 { padding-top: calc(1rem * 0.78) !important; }
        .content-wrapper .pt-6 { padding-top: calc(1.5rem * 0.78) !important; }
        .content-wrapper .pt-8 { padding-top: calc(2rem * 0.78) !important; }
        .content-wrapper .pb-1 { padding-bottom: calc(0.25rem * 0.78) !important; }
        .content-wrapper .pb-3 { padding-bottom: calc(0.75rem * 0.78) !important; }
        .content-wrapper .pb-4 { padding-bottom: calc(1rem * 0.78) !important; }
        .content-wrapper .pb-6 { padding-bottom: calc(1.5rem * 0.78) !important; }
        .content-wrapper .pb-20 { padding-bottom: calc(5rem * 0.78) !important; }
        /* Reduce spacing - margin */
        .content-wrapper .mb-1 { margin-bottom: calc(0.25rem * 0.78) !important; }
        .content-wrapper .mb-2 { margin-bottom: calc(0.5rem * 0.78) !important; }
        .content-wrapper .mb-3 { margin-bottom: calc(0.75rem * 0.78) !important; }
        .content-wrapper .mb-4 { margin-bottom: calc(1rem * 0.78) !important; }
        .content-wrapper .mb-6 { margin-bottom: calc(1.5rem * 0.78) !important; }
        .content-wrapper .mb-8 { margin-bottom: calc(2rem * 0.78) !important; }
        .content-wrapper .mt-1 { margin-top: calc(0.25rem * 0.78) !important; }
        .content-wrapper .mt-2 { margin-top: calc(0.5rem * 0.78) !important; }
        .content-wrapper .mt-3 { margin-top: calc(0.75rem * 0.78) !important; }
        .content-wrapper .mt-4 { margin-top: calc(1rem * 0.78) !important; }
        .content-wrapper .mt-6 { margin-top: calc(1.5rem * 0.78) !important; }
        .content-wrapper .mt-8 { margin-top: calc(2rem * 0.78) !important; }
        .content-wrapper .mt-12 { margin-top: calc(3rem * 0.78) !important; }
        /* Reduce gaps */
        .content-wrapper .gap-1 { gap: calc(0.25rem * 0.78) !important; }
        .content-wrapper .gap-2 { gap: calc(0.5rem * 0.78) !important; }
        .content-wrapper .gap-3 { gap: calc(0.75rem * 0.78) !important; }
        .content-wrapper .gap-4 { gap: calc(1rem * 0.78) !important; }
        .content-wrapper .gap-6 { gap: calc(1.5rem * 0.78) !important; }
        .content-wrapper .gap-8 { gap: calc(2rem * 0.78) !important; }
        /* Reduce space-y utilities */
        .content-wrapper .space-y-1 > * + * { margin-top: calc(0.25rem * 0.78) !important; }
        .content-wrapper .space-y-2 > * + * { margin-top: calc(0.5rem * 0.78) !important; }
        .content-wrapper .space-y-3 > * + * { margin-top: calc(0.75rem * 0.78) !important; }
        .content-wrapper .space-y-4 > * + * { margin-top: calc(1rem * 0.78) !important; }
        .content-wrapper .space-y-6 > * + * { margin-top: calc(1.5rem * 0.78) !important; }
        .content-wrapper .space-y-8 > * + * { margin-top: calc(2rem * 0.78) !important; }
    </style>
<body class="bg-background min-h-screen">
    <!-- Header Navigation -->
    <header class="bg-surface shadow-card border-b border-border fixed top-0 left-0 right-0 z-50" style="padding-top: max(2rem, env(safe-area-inset-top));">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="../restaurants/restaurant_browse.html" class="flex items-center">
                        <img src="../../public/logos/app_logo.png" alt="HATOD Logo" class="w-10 h-10 mr-3 object-contain">
                        <h1 class="text-xl font-bold text-text-primary">HATOD</h1>
                    </a>
                </div>

                <!-- Navigation -->
                <nav class="hidden md:flex space-x-8">
                    <a href="../restaurants/restaurant_browse.html" class="text-text-secondary hover:text-primary transition-smooth">Browse</a>
                    <a href="order_tracking.html" class="text-text-secondary hover:text-primary transition-smooth">Orders</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8">
        <div class="content-wrapper">
        <!-- Breadcrumb -->
        <div class="mb-6">
            <div class="flex items-center space-x-2 text-sm text-text-secondary">
                <a href="../restaurants/restaurant_browse.html" class="hover:text-primary transition-smooth">Browse</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <a href="shopping_cart.html" class="hover:text-primary transition-smooth">Cart</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <span class="text-text-primary">Checkout</span>
            </div>
        </div>

        <!-- Page Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-text-primary mb-2">Checkout</h2>
            <p class="text-text-secondary">Review your order and complete your purchase</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Checkout Form -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Delivery Address -->
                <section class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Delivery Address</h3>
                    <div class="space-y-4">
                        <div id="location-status" class="space-y-3">
                            <button id="fetch-location-btn" 
                                    onclick="fetchCustomerLocation()" 
                                    class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary-600 transition-smooth btn-hover flex items-center justify-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span>Fetch My Location</span>
                            </button>
                            
                            <div id="location-loading" class="hidden p-3 bg-blue-50 rounded-lg">
                                <div class="flex items-center space-x-2">
                                    <svg class="animate-spin w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                    <span class="text-blue-600 text-sm font-medium">Fetching your location...</span>
                                </div>
                            </div>

                            <div id="address-display" class="hidden p-4 bg-gray-50 rounded-lg border border-border">
                                <div class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-success mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-text-primary mb-1">Delivery Address:</p>
                                        <p id="address-text" class="text-sm text-text-secondary"></p>
                                        <p id="barangay-text" class="text-xs text-primary mt-1 font-medium"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Barangay Validation Warning -->
                        <div id="barangay-warning" class="hidden p-3 bg-warning-50 border border-warning-200 rounded-lg">
                            <div class="flex items-start space-x-2">
                                <svg class="w-5 h-5 text-warning flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div class="flex-1">
                                    <div class="text-warning font-medium text-sm mb-1">Delivery Not Available</div>
                                    <div class="text-warning text-xs" id="barangay-warning-text"></div>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 bg-success-50 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="text-success text-sm font-medium">Estimated delivery: 30-40 min</span>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden fields for address data -->
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <input type="hidden" id="full-address" name="fullAddress">
                    <input type="hidden" id="barangay" name="barangay">
                </section>

                <!-- Payment Method -->
                <section class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Payment Method</h3>
                    <div class="space-y-4">
                        <!-- Cash Payment Only -->
                        <div class="border border-primary rounded-lg bg-primary-50">
                            <div class="flex items-center p-4">
                                <input type="radio" name="payment_method" value="cash" checked readonly class="h-5 w-5 text-primary focus:ring-primary border-border">
                                <div class="ml-4 flex-1">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-semibold text-text-primary">Cash on Delivery</h3>
                                            <p class="text-text-secondary">Pay in cash when your order arrives. Delivery rider will show the admin's GCash QR code for payment.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Cash Details -->
                            <div class="mx-4 mb-4 px-4 py-3 bg-green-50 rounded-lg">
                                <p class="text-sm text-green-800">
                                    <strong>Cash Payment Instructions:</strong><br>
                                    ‚Ä¢ Pay the exact amount: ‚Ç±<span id="cash-amount">0.00</span><br>
                                    ‚Ä¢ Prepare exact change if possible<br>
                                    ‚Ä¢ Delivery rider will show admin's GCash QR code<br>
                                    ‚Ä¢ Payment collected by delivery rider upon delivery
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Order & Delivery Schedule -->
                <section class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Order & Delivery Schedule</h3>
                    <p class="text-sm text-text-secondary mb-4">
                        <em>(Delivery time indicates the start of delivery trips from the Municipality of Claver to different barangays.)</em>
                    </p>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">9:00 AM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïó <strong>Order Time:</strong> 8:00 AM ‚Äì 8:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">10:00 AM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïò <strong>Order Time:</strong> 8:40 AM ‚Äì 9:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">11:00 AM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïô <strong>Order Time:</strong> 9:40 AM ‚Äì 10:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">12:00 noon Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïô <strong>Order Time:</strong> 10:40 AM ‚Äì 11:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">1:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïõ <strong>Order Time:</strong> 11:40 NN ‚Äì 12:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">2:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïê <strong>Order Time:</strong> 12:40 PM ‚Äì 1:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">3:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïë <strong>Order Time:</strong> 1:40 PM ‚Äì 2:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">4:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïí <strong>Order Time:</strong> 2:40 PM ‚Äì 3:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">5:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïì <strong>Order Time:</strong> 3:40 PM ‚Äì 4:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">6:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïî <strong>Order Time:</strong> 4:40 PM ‚Äì 5:40 PM
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-surface rounded-lg shadow-card border border-border sticky top-8">
                    <!-- Restaurant Info -->
                    <div class="p-6 border-b border-border">
                        <div class="flex items-center space-x-3">
                            <img src="https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" 
                                 alt="Pizza Palace" 
                                 class="w-12 h-12 rounded-lg object-cover"
                                 onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                            <div>
                                <h4 class="font-semibold text-text-primary">Pizza Palace</h4>
                                <p class="text-sm text-text-secondary">25-35 min ‚Ä¢ ‚Ç±50.00 delivery</p>
                            </div>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="p-6 border-b border-border">
                        <h3 class="font-semibold text-text-primary mb-4">Order Summary</h3>
                        <div class="space-y-3">
                            <!-- Order items will be loaded here -->
                        </div>
                    </div>

                    <!-- Price Breakdown -->
                    <div class="p-6">
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Subtotal</span>
                                <span class="text-text-primary">‚Ç±0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Delivery fee</span>
                                <span class="text-text-primary">‚Ç±50.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Tax</span>
                                <span class="text-text-primary">‚Ç±0.00</span>
                            </div>
                            <div class="border-t border-border pt-2 mt-2">
                                <div class="flex justify-between">
                                    <span class="font-semibold text-text-primary">Total</span>
                                    <span class="font-bold text-text-primary text-lg">‚Ç±0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Place Order Button -->
                        <button onclick="placeOrder()" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary-600 transition-smooth btn-hover">
                            Place Order
                        </button>

                        <p class="text-xs text-text-secondary text-center mt-3">By placing your order, you agree to our Terms of Service and Privacy Policy</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Number Warning -->
        <div id="mobile-number-warning" class="hidden fixed z-50" style="top: calc(4rem + max(2rem, env(safe-area-inset-top))); left: 0; right: 0; margin: 1rem;">
            <div class="max-w-2xl mx-auto bg-warning-50 border border-warning-200 rounded-lg p-4 shadow-lg">
                <div class="flex items-start space-x-3">
                    <svg class="w-6 h-6 text-warning flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <h4 class="text-warning font-semibold mb-1">Mobile Number Required</h4>
                        <p class="text-warning text-sm mb-3">You need to add your mobile number to your profile before placing an order. This is required for delivery coordination.</p>
                        <a href="customer_profile.html" class="inline-block bg-warning text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-warning-600 transition-smooth">
                            Go to Profile
                        </a>
                    </div>
                    <button onclick="document.getElementById('mobile-number-warning').classList.add('hidden')" class="text-warning hover:text-warning-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-surface border-t border-border mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <p class="text-text-secondary text-sm">¬© 2025 HATOD. All Rights Reserved.</p>
                <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Privacy Policy</a>
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Terms of Service</a>
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Support</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="../../public/config.js"></script>
    <script>
        // API base URL (from config.js - automatically uses Railway URL in mobile apps)
        const API_BASE_URL = window.API_BASE_URL || 'http://localhost:4000/api';

        document.addEventListener('DOMContentLoaded', () => {
            loadCheckoutData();
        });

        // Mapbox access token for reverse geocoding
        const MAPBOX_TOKEN = 'pk.eyJ1Ijoia3JpZGxsbCIsImEiOiJjbWljdzdmYXUwb3I1MmpwcTJyNWVsN252In0.2lBD_f8wyFrpViRg8n6cOw';
        let allowedBarangays = [];

        // Load allowed barangays on page load
        async function loadAllowedBarangays() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_BASE_URL}/delivery-fees/tiers`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    allowedBarangays = Object.keys(data.data || {});
                    console.log('Allowed barangays loaded:', allowedBarangays);
                }
            } catch (error) {
                console.error('Error loading allowed barangays:', error);
            }
        }

        // Fetch customer location when button is clicked
        async function fetchCustomerLocation() {
            const locationLoading = document.getElementById('location-loading');
            const fetchBtn = document.getElementById('fetch-location-btn');
            const addressDisplay = document.getElementById('address-display');
            const barangayWarning = document.getElementById('barangay-warning');
            
            // Hide previous results
            addressDisplay.classList.add('hidden');
            barangayWarning.classList.add('hidden');
            
            // Load allowed barangays if not loaded
            if (allowedBarangays.length === 0) {
                await loadAllowedBarangays();
            }
            
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser. Please use a different browser.');
                return;
            }

            // Show loading state
            if (locationLoading) locationLoading.classList.remove('hidden');
            if (fetchBtn) {
                fetchBtn.disabled = true;
                fetchBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }

            try {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        console.log('Location fetched:', { latitude, longitude });
                        
                        // Store coordinates in hidden fields
                        document.getElementById('latitude').value = latitude;
                        document.getElementById('longitude').value = longitude;
                        
                        // Reverse geocode to get address and extract barangay
                        await reverseGeocode(longitude, latitude);
                        
                        // Hide loading indicator
                        if (locationLoading) locationLoading.classList.add('hidden');
                        if (fetchBtn) {
                            fetchBtn.disabled = false;
                            fetchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    },
                    async (error) => {
                        console.error('Error fetching location:', error);
                        
                        // Hide loading indicator
                        if (locationLoading) locationLoading.classList.add('hidden');
                        if (fetchBtn) {
                            fetchBtn.disabled = false;
                            fetchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                        
                        let errorMessage = 'Failed to fetch location. ';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage += 'Please allow location access and try again.';
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage += 'Location request timed out. Please try again.';
                        } else {
                            errorMessage += 'Please try again.';
                        }
                        alert(errorMessage);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } catch (error) {
                console.error('Error in fetchCustomerLocation:', error);
                if (locationLoading) locationLoading.classList.add('hidden');
                if (fetchBtn) {
                    fetchBtn.disabled = false;
                    fetchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                alert('An error occurred while fetching location. Please try again.');
            }
        }

        // Reverse geocode coordinates to get address and extract barangay
        async function reverseGeocode(lng, lat) {
            try {
                const response = await fetch(
                    `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${MAPBOX_TOKEN}&country=PH`
                );
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    const placeName = feature.place_name || '';
                    const context = feature.context || [];
                    
                    // Store full address
                    document.getElementById('full-address').value = placeName;
                    
                    // Extract barangay from address
                    // Barangay might be in different parts of the address
                    let barangay = null;
                    
                    // Normalize allowed barangays for matching
                    const normalizedBarangays = allowedBarangays.map(b => ({
                        original: b,
                        normalized: b.toLowerCase().replace(/^barangay\s+/i, '').trim(),
                        fullLower: b.toLowerCase()
                    }));
                    
                    // Check context items for barangay - prioritize place name (without "Barangay" prefix)
                    // Look for context items with "locality" or "neighborhood" type that might contain barangay
                    for (const ctx of context) {
                        const text = (ctx.text || '').toLowerCase().trim();
                        const id = (ctx.id || '').toLowerCase();
                        
                        // Only check if this is a locality or neighborhood context
                        if (id.includes('locality') || id.includes('neighborhood') || id.includes('place')) {
                            // Prioritize matching just the place name (e.g., "tayaga", "espina") without "Barangay" prefix
                            for (const { original, normalized, fullLower } of normalizedBarangays) {
                                // First check for normalized name only (e.g., "espina", "tayaga") - most flexible
                                if (normalized.length >= 3) {
                                    // Exact match for normalized name
                                    if (text === normalized) {
                                        barangay = original;
                                        break;
                                    }
                                    // Word boundary match for normalized name
                                    const normalizedRegex = new RegExp(`\\b${normalized.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
                                    if (normalizedRegex.test(text)) {
                                        barangay = original;
                                        break;
                                    }
                                }
                                // Then check for full "Barangay X" format
                                if (text === fullLower) {
                                    barangay = original;
                                    break;
                                }
                                if (fullLower.length > 3) {
                                    const fullRegex = new RegExp(`\\b${fullLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
                                    if (fullRegex.test(text)) {
                                        barangay = original;
                                        break;
                                    }
                                }
                            }
                        }
                        if (barangay) break;
                    }
                    
                    // Check full address string - but only if no match found yet
                    // Prioritize matching just the place name (e.g., "tayaga", "espina") without "Barangay" prefix
                    if (!barangay) {
                        const addressLower = placeName.toLowerCase();
                        for (const { original, normalized, fullLower } of normalizedBarangays) {
                            // Prioritize matching just the place name (without "Barangay" prefix)
                            if (normalized.length >= 3) {
                                // Use word boundaries to ensure exact match
                                const patterns = [
                                    // First: Check for just the normalized name (e.g., "tayaga", "espina") - most flexible
                                    new RegExp(`\\b${normalized.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i'),
                                    // Then: Check for "Barangay X" format
                                    new RegExp(`\\bbarangay ${normalized.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i'),
                                    // Finally: Check for abbreviated format "Brgy. X"
                                    new RegExp(`\\bbrgy[\\s\\.]${normalized.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i')
                                ];
                                
                                for (const pattern of patterns) {
                                    if (pattern.test(addressLower)) {
                                        barangay = original;
                                        console.log('Barangay matched from address pattern:', { pattern: pattern.toString(), barangay });
                                        break;
                                    }
                                }
                            }
                            if (barangay) break;
                        }
                    }
                    
                    console.log('=== BARANGAY EXTRACTION ===');
                    console.log('Address:', placeName);
                    console.log('Extracted barangay:', barangay);
                    console.log('Is in allowed list:', barangay ? allowedBarangays.includes(barangay) : false);
                    console.log('Context items:', context.map(c => ({ id: c.id, text: c.text })));
                    
                    // Store barangay - only if actually found in address
                    document.getElementById('barangay').value = barangay || '';
                    
                    // Display address
                    const addressDisplay = document.getElementById('address-display');
                    const addressText = document.getElementById('address-text');
                    const barangayText = document.getElementById('barangay-text');
                    const barangayWarning = document.getElementById('barangay-warning');
                    const warningText = document.getElementById('barangay-warning-text');
                    
                    if (addressText) {
                        addressText.textContent = placeName;
                    }
                    
                    // Only display barangay if it was actually found in the address
                    // Validate barangay
                    if (!barangay || !allowedBarangays.includes(barangay)) {
                        // Hide address display
                        addressDisplay.classList.add('hidden');
                        
                        // Clear barangay text if not found
                        if (barangayText) {
                            barangayText.textContent = '';
                        }
                        
                        // Show warning
                        if (barangayWarning) {
                            let warningMessage = 'Your location is outside our delivery area. ';
                            if (allowedBarangays.length > 0) {
                                warningMessage += `We currently deliver to: ${allowedBarangays.join(', ')}.`;
                            } else {
                                warningMessage += 'Please contact support for delivery availability.';
                            }
                            if (warningText) {
                                warningText.textContent = warningMessage;
                            }
                            barangayWarning.classList.remove('hidden');
                        }
                        
                        // Disable place order button
                        disablePlaceOrder('Delivery not available to your location');
                    } else {
                        // Show address display
                        addressDisplay.classList.remove('hidden');
                        // Only show barangay if it was found, is valid, and is in the allowed list
                        if (barangayText) {
                            if (barangay && allowedBarangays.includes(barangay)) {
                                barangayText.textContent = `Barangay: ${barangay}`;
                            } else {
                                // Clear barangay text if not found or invalid
                                barangayText.textContent = '';
                            }
                        }
                        
                        // Hide warning
                        barangayWarning.classList.add('hidden');
                        
                        // Enable place order button
                        enablePlaceOrder();
                        
                        // Calculate and update delivery fee based on validated barangay
                        await updateDeliveryFee(barangay);
                    }
                    
                    console.log('Address processed:', { placeName, barangay, isValid: allowedBarangays.includes(barangay || '') });
                }
            } catch (error) {
                console.error('Error reverse geocoding:', error);
                alert('Failed to get address from location. Please try again.');
            }
        }

        function disablePlaceOrder(reason) {
            const placeOrderBtn = document.querySelector('button[onclick="placeOrder()"]');
            if (placeOrderBtn) {
                placeOrderBtn.disabled = true;
                placeOrderBtn.classList.add('opacity-50', 'cursor-not-allowed');
                placeOrderBtn.classList.remove('btn-hover');
                placeOrderBtn.title = reason || 'Delivery not available';
            }
        }

        function enablePlaceOrder() {
            const placeOrderBtn = document.querySelector('button[onclick="placeOrder()"]');
            if (placeOrderBtn) {
                placeOrderBtn.disabled = false;
                placeOrderBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                placeOrderBtn.classList.add('btn-hover');
                placeOrderBtn.title = '';
            }
        }

        function showMobileNumberWarning() {
            const warning = document.getElementById('mobile-number-warning');
            if (warning) {
                warning.classList.remove('hidden');
            }
        }

        async function loadCheckoutData() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Please log in to continue');
                    window.location.href = '../login.html';
                    return;
                }

                // Decode JWT to get customer ID (simple decode, not secure)
                const payload = JSON.parse(atob(token.split('.')[1]));
                const customerId = payload.sub;

                // Check if customer has mobile number first
                let hasMobileNumber = true;
                const profileResponse = await fetch(`${API_BASE_URL}/customers/${customerId}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    const profile = profileData.data;
                    
                    if (!profile.phone || profile.phone.trim() === '') {
                        hasMobileNumber = false;
                        // Disable place order button and show warning
                        disablePlaceOrder('Please add your mobile number in your profile');
                        showMobileNumberWarning();
                    }
                } else {
                    console.warn('Failed to load customer profile, continuing anyway');
                }

                console.log('[Checkout] Loading cart data...');
                // Load cart data
                const cartResponse = await fetch(`${API_BASE_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!cartResponse.ok) {
                    const errorData = await cartResponse.json().catch(() => ({ message: 'Failed to load cart' }));
                    throw new Error(errorData.message || 'Failed to load cart');
                }

                const cartData = await cartResponse.json();
                const cart = cartData.data || [];
                console.log('[Checkout] Cart data loaded:', cart);

                if (cart.length === 0) {
                    alert('Your cart is empty');
                    window.location.href = 'shopping_cart.html';
                    return;
                }

                // Load allowed barangays
                await loadAllowedBarangays();

                // Update UI with real data
                updateRestaurantInfo(cart);
                await updateOrderSummary(cart);
                
                // Initially disable place order button until location is fetched (only if mobile number exists)
                if (hasMobileNumber) {
                    disablePlaceOrder('Please fetch your location first');
                }

            } catch (error) {
                console.error('[Checkout] Error loading checkout data:', error);
                alert('Failed to load checkout data: ' + error.message);
            }
        }

        function updateRestaurantInfo(cart) {
            if (cart.length === 0) return;

            const firstItem = cart[0];
            const restaurantLogo = document.querySelector('img[alt="Pizza Palace"]');
            const restaurantName = document.querySelector('h4.font-semibold.text-text-primary');
            const deliveryInfo = document.querySelector('p.text-sm.text-text-secondary');

            restaurantLogo.src = firstItem.restaurantImageUrl || restaurantLogo.src;
            restaurantName.textContent = firstItem.restaurantName || 'Restaurant';
            deliveryInfo.textContent = '25-35 min ‚Ä¢ ‚Ç±50 delivery';
        }

        async function updateOrderSummary(cart) {
            // Find the order summary section more specifically
            const orderSummarySection = document.querySelector('.lg\\:col-span-1 .space-y-3') || 
                                       document.querySelector('.p-6.border-b .space-y-3');
            
            if (!orderSummarySection) {
                console.error('Order summary container not found');
                return;
            }

            // Find price elements more reliably - look within the price breakdown section
            const priceBreakdown = document.querySelector('.p-6:not(.border-b) .space-y-2') ||
                                  document.querySelector('.lg\\:col-span-1 .space-y-2');
            
            if (!priceBreakdown) {
                console.error('Price breakdown container not found');
                return;
            }
            
            const priceElements = priceBreakdown.querySelectorAll('.flex.justify-between.text-sm span:last-child');
            const subtotalElement = priceElements[0]; // Subtotal
            const deliveryFeeElement = priceElements[1]; // Delivery fee
            const taxElement = priceElements[2]; // Tax

            const totalElement = document.querySelector('.border-t.border-border .flex.justify-between span:last-child');

            let orderItemsHtml = '';
            let subtotal = 0;

            cart.forEach(item => {
                // For items with variants, use variantPrice, otherwise use price
                const price = item.variantPrice ? parseFloat(item.variantPrice) : (item.price ? parseFloat(item.price) : 0);
                const quantity = item.quantity || 1;
                const itemTotal = (isNaN(price) ? 0 : price) * (isNaN(quantity) ? 1 : quantity);
                subtotal += isNaN(itemTotal) ? 0 : itemTotal;
                
                // Show variant name if available
                const variantInfo = item.variantName ? ` (${item.variantName})` : '';

                orderItemsHtml += `
                    <div class="flex justify-between text-sm">
                        <span class="text-text-secondary">${item.name}${variantInfo} x${item.quantity}</span>
                        <span class="text-text-primary">‚Ç±${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            });

            orderSummarySection.innerHTML = orderItemsHtml;

            // Initially set delivery fee to 0 - will be calculated after address is fetched and validated
            const validSubtotal = isNaN(subtotal) ? 0 : subtotal;
            const deliveryFee = 0; // Delivery fee calculated after address validation
            const total = validSubtotal + deliveryFee;

            if (subtotalElement) subtotalElement.textContent = `‚Ç±${validSubtotal.toFixed(2)}`;
            if (deliveryFeeElement) deliveryFeeElement.textContent = `‚Ç±0.00`;
            if (taxElement) taxElement.textContent = `‚Ç±0.00`;
            if (totalElement) totalElement.textContent = `‚Ç±${total.toFixed(2)}`;

            // Update cash payment instructions
            const cashAmountElement = document.getElementById('cash-amount');
            if (cashAmountElement) {
                cashAmountElement.textContent = total.toFixed(2);
            }

            // Update delivery info - will be updated after address validation
            const deliveryInfo = document.querySelector('p.text-sm.text-text-secondary');
            if (deliveryInfo) {
                deliveryInfo.textContent = '25-35 min ‚Ä¢ Delivery fee calculated after address confirmation';
            }
            
            // Store subtotal for later use
            window.checkoutSubtotal = validSubtotal;
        }

        async function updateDeliveryFee(barangay) {
            try {
                const subtotal = window.checkoutSubtotal || 0;
                
                if (!barangay) {
                    console.error('No barangay provided for delivery fee calculation');
                    return;
                }

                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.error('No auth token found');
                    return;
                }

                // Calculate delivery fee based on validated barangay and order amount
                const feeResponse = await fetch(`${API_BASE_URL}/delivery-fees/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        barangay: barangay,
                        orderAmount: subtotal
                    })
                });

                if (!feeResponse.ok) {
                    throw new Error('Failed to calculate delivery fee');
                }

                const feeData = await feeResponse.json();
                const deliveryFee = parseFloat(feeData.data.deliveryFee) || 0;

                // Find price elements
                const priceBreakdown = document.querySelector('.p-6:not(.border-b) .space-y-2') ||
                                      document.querySelector('.lg\\:col-span-1 .space-y-2');
                
                if (!priceBreakdown) {
                    console.error('Price breakdown container not found');
                    return;
                }

                const priceElements = priceBreakdown.querySelectorAll('.flex.justify-between.text-sm span:last-child');
                const deliveryFeeElement = priceElements[1]; // Delivery fee
                const totalElement = document.querySelector('.border-t.border-border .flex.justify-between span:last-child');

                // Get current subtotal
                const subtotalElement = priceElements[0];
                const currentSubtotalText = subtotalElement ? subtotalElement.textContent : '‚Ç±0.00';
                const currentSubtotal = parseFloat(currentSubtotalText.replace('‚Ç±', '').replace(',', '')) || subtotal;

                // Calculate new total
                const validSubtotal = isNaN(currentSubtotal) ? 0 : currentSubtotal;
                const validDeliveryFee = isNaN(deliveryFee) ? 0 : deliveryFee;
                const total = validSubtotal + validDeliveryFee;

                // Update UI
                if (deliveryFeeElement) {
                    deliveryFeeElement.textContent = `‚Ç±${validDeliveryFee.toFixed(2)}`;
                }
                if (totalElement) {
                    totalElement.textContent = `‚Ç±${total.toFixed(2)}`;
                }

                // Update cash payment instructions
                const cashAmountElement = document.getElementById('cash-amount');
                if (cashAmountElement) {
                    cashAmountElement.textContent = total.toFixed(2);
                }

                // Update delivery info
                const deliveryInfo = document.querySelector('p.text-sm.text-text-secondary');
                if (deliveryInfo) {
                    deliveryInfo.textContent = `25-35 min ‚Ä¢ ‚Ç±${validDeliveryFee.toFixed(2)} delivery`;
                }

                console.log('Delivery fee updated:', { barangay, deliveryFee, subtotal, total });
            } catch (error) {
                console.error('Error calculating delivery fee:', error);
                // Don't show alert, just log error - delivery fee will remain 0
            }
        }

        async function placeOrder() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Please log in to continue');
                    window.location.href = '../login.html';
                    return;
                }

                // Decode JWT to get customer ID
                const payload = JSON.parse(atob(token.split('.')[1]));
                const customerId = payload.sub;

                // Validate mobile number before proceeding
                const profileResponse = await fetch(`${API_BASE_URL}/customers/${customerId}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    const profile = profileData.data;
                    
                    if (!profile.phone || profile.phone.trim() === '') {
                        const addMobile = confirm(
                            'You need to add your mobile number to your profile before placing an order.\n\n' +
                            'Would you like to go to your profile page to add it now?'
                        );
                        if (addMobile) {
                            window.location.href = 'customer_profile.html';
                        }
                        return;
                    }
                } else {
                    // If we can't check profile, show warning but allow to continue
                    console.warn('Could not verify mobile number, but allowing order to proceed');
                }

                // Get address from fetched location
                const fullAddress = document.getElementById('full-address').value.trim();
                const barangay = document.getElementById('barangay').value.trim();
                const latitude = document.getElementById('latitude').value;
                const longitude = document.getElementById('longitude').value;

                // Validate that location was fetched
                if (!fullAddress || !latitude || !longitude) {
                    alert('Please fetch your location first by clicking "Fetch My Location" button');
                    return;
                }

                // Validate barangay
                if (!barangay) {
                    alert('Unable to determine your barangay from the location. Delivery is only available to specific areas. Please contact support if you believe this is an error.');
                    return;
                }

                // Validate barangay is in allowed list
                if (allowedBarangays.length === 0) {
                    await loadAllowedBarangays();
                }

                if (!allowedBarangays.includes(barangay)) {
                    alert(
                        `Delivery is not available to your location (${barangay}).\n\n` +
                        `We currently deliver to:\n${allowedBarangays.join(', ')}\n\n` +
                        `Please contact support if you believe this is an error.`
                    );
                    return;
                }

                // Token and customerId already obtained above

                // Parse address components from full address
                // Mapbox format: "Street, Neighborhood/Barangay, City, Region, Country"
                const addressParts = fullAddress.split(',').map(s => s.trim());
                const streetAddress = fullAddress; // Use full address as street address
                const city = addressParts.length > 2 ? addressParts[addressParts.length - 3] : (addressParts[addressParts.length - 2] || '');
                const zipCode = ''; // ZIP code might not be in the address string

                // Create a temporary address for this order
                let deliveryAddressId = null;
                try {
                    const addressData = {
                        label: 'Delivery Address',
                        streetAddress: streetAddress,
                        city: city || barangay, // Use barangay as city if city not found
                        zipCode: zipCode || '0000',
                        apartment: null,
                        state: null,
                        latitude: latitude ? parseFloat(latitude) : null,
                        longitude: longitude ? parseFloat(longitude) : null,
                        isDefault: false
                    };

                    const addressResponse = await fetch(`${API_BASE_URL}/customers/${customerId}/addresses`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(addressData)
                    });

                    if (!addressResponse.ok) {
                        const errorData = await addressResponse.json().catch(() => ({ message: 'Failed to create address' }));
                        throw new Error(errorData.message || 'Failed to create delivery address');
                    }

                    const addressResult = await addressResponse.json();
                    deliveryAddressId = addressResult.data.id;
                    console.log('Temporary address created:', deliveryAddressId);
                } catch (addressError) {
                    console.error('Error creating address:', addressError);
                    alert('Failed to create delivery address: ' + addressError.message);
                    return;
                }

                // Get cart data again to ensure we have the latest
                const cartResponse = await fetch(`${API_BASE_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!cartResponse.ok) {
                    throw new Error('Failed to load cart for order');
                }

                const cartData = await cartResponse.json();
                const cart = cartData.data || [];

                if (cart.length === 0) {
                    alert('Your cart is empty');
                    window.location.href = 'shopping_cart.html';
                    return;
                }

                // Get restaurant ID from first cart item
                const restaurantId = cart[0].restaurantId;

                // Convert cart items to order items format
                const items = cart.map(item => ({
                    menuItemId: item.menuItemId,
                    variantId: item.variantId || null,
                    quantity: item.quantity,
                    specialInstructions: item.specialInstructions || null
                }));

                const orderData = {
                    customerId,
                    restaurantId,
                    deliveryAddressId: deliveryAddressId,
                    orderType: 'delivery',
                    tipAmount: 0,
                    items,
                    specialInstructions: null
                };

                const response = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to place order');
                }

                const result = await response.json();
                console.log('Order placed:', result);

                // Clear cart after successful order
                await fetch(`${API_BASE_URL}/cart`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                // Redirect to payment confirmation with order ID
                window.location.href = `payment_confirmation.html?orderId=${result.data.orderId}`;

            } catch (error) {
                console.error('Error placing order:', error);
                alert('Failed to place order: ' + error.message);
            }
        }
    </script>
<script id="dhws-dataInjector" src="../../public/dhws-data-injector.js"></script>
</body>
</html>

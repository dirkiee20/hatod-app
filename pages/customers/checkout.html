<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Checkout - HATOD</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/pages.css">
  
  
  
  </head>
    <style>
        html, body {
            overflow-x: hidden;
            position: relative;
        }
        body {
            margin: 0;
            padding: 0;
        }
        .content-wrapper {
            margin-top: calc(4rem + max(2rem, env(safe-area-inset-top))); /* Push content below fixed header */
            margin-bottom: 0; /* No margin-bottom, padding-bottom on main handles spacing */
            font-size: 0.78em; /* Base font size reduction by 22% */
        }
        @media (min-width: 1024px) {
            .content-wrapper {
                margin-bottom: 0; /* No bottom margin on desktop */
            }
            main {
                padding-bottom: 2rem !important; /* Reset to normal padding on desktop */
            }
        }
        /* Reduce font sizes */
        .content-wrapper .text-xs { font-size: calc(0.75rem * 0.78) !important; line-height: calc(1rem * 0.78) !important; }
        .content-wrapper .text-sm { font-size: calc(0.875rem * 0.78) !important; line-height: calc(1.25rem * 0.78) !important; }
        .content-wrapper .text-base { font-size: calc(1rem * 0.78) !important; line-height: calc(1.5rem * 0.78) !important; }
        .content-wrapper .text-lg { font-size: calc(1.125rem * 0.78) !important; line-height: calc(1.75rem * 0.78) !important; }
        .content-wrapper .text-xl { font-size: calc(1.25rem * 0.78) !important; line-height: calc(1.75rem * 0.78) !important; }
        .content-wrapper .text-2xl { font-size: calc(1.5rem * 0.78) !important; line-height: calc(2rem * 0.78) !important; }
        .content-wrapper .text-3xl { font-size: calc(1.875rem * 0.78) !important; line-height: calc(2.25rem * 0.78) !important; }
        /* Reduce spacing - padding */
        .content-wrapper .p-1 { padding: calc(0.25rem * 0.78) !important; }
        .content-wrapper .p-2 { padding: calc(0.5rem * 0.78) !important; }
        .content-wrapper .p-3 { padding: calc(0.75rem * 0.78) !important; }
        .content-wrapper .p-4 { padding: calc(1rem * 0.78) !important; }
        .content-wrapper .p-6 { padding: calc(1.5rem * 0.78) !important; }
        .content-wrapper .p-8 { padding: calc(2rem * 0.78) !important; }
        .content-wrapper .p-12 { padding: calc(3rem * 0.78) !important; }
        .content-wrapper .px-1 { padding-left: calc(0.25rem * 0.78) !important; padding-right: calc(0.25rem * 0.78) !important; }
        .content-wrapper .px-2 { padding-left: calc(0.5rem * 0.78) !important; padding-right: calc(0.5rem * 0.78) !important; }
        .content-wrapper .px-3 { padding-left: calc(0.75rem * 0.78) !important; padding-right: calc(0.75rem * 0.78) !important; }
        .content-wrapper .px-4 { padding-left: calc(1rem * 0.78) !important; padding-right: calc(1rem * 0.78) !important; }
        .content-wrapper .px-6 { padding-left: calc(1.5rem * 0.78) !important; padding-right: calc(1.5rem * 0.78) !important; }
        .content-wrapper .px-8 { padding-left: calc(2rem * 0.78) !important; padding-right: calc(2rem * 0.78) !important; }
        .content-wrapper .py-1 { padding-top: calc(0.25rem * 0.78) !important; padding-bottom: calc(0.25rem * 0.78) !important; }
        .content-wrapper .py-2 { padding-top: calc(0.5rem * 0.78) !important; padding-bottom: calc(0.5rem * 0.78) !important; }
        .content-wrapper .py-3 { padding-top: calc(0.75rem * 0.78) !important; padding-bottom: calc(0.75rem * 0.78) !important; }
        .content-wrapper .py-4 { padding-top: calc(1rem * 0.78) !important; padding-bottom: calc(1rem * 0.78) !important; }
        .content-wrapper .py-6 { padding-top: calc(1.5rem * 0.78) !important; padding-bottom: calc(1.5rem * 0.78) !important; }
        .content-wrapper .py-8 { padding-top: calc(2rem * 0.78) !important; padding-bottom: calc(2rem * 0.78) !important; }
        .content-wrapper .py-12 { padding-top: calc(3rem * 0.78) !important; padding-bottom: calc(3rem * 0.78) !important; }
        .content-wrapper .pt-2 { padding-top: calc(0.5rem * 0.78) !important; }
        .content-wrapper .pt-3 { padding-top: calc(0.75rem * 0.78) !important; }
        .content-wrapper .pt-4 { padding-top: calc(1rem * 0.78) !important; }
        .content-wrapper .pt-6 { padding-top: calc(1.5rem * 0.78) !important; }
        .content-wrapper .pt-8 { padding-top: calc(2rem * 0.78) !important; }
        .content-wrapper .pb-1 { padding-bottom: calc(0.25rem * 0.78) !important; }
        .content-wrapper .pb-3 { padding-bottom: calc(0.75rem * 0.78) !important; }
        .content-wrapper .pb-4 { padding-bottom: calc(1rem * 0.78) !important; }
        .content-wrapper .pb-6 { padding-bottom: calc(1.5rem * 0.78) !important; }
        .content-wrapper .pb-20 { padding-bottom: calc(5rem * 0.78) !important; }
        /* Reduce spacing - margin */
        .content-wrapper .mb-1 { margin-bottom: calc(0.25rem * 0.78) !important; }
        .content-wrapper .mb-2 { margin-bottom: calc(0.5rem * 0.78) !important; }
        .content-wrapper .mb-3 { margin-bottom: calc(0.75rem * 0.78) !important; }
        .content-wrapper .mb-4 { margin-bottom: calc(1rem * 0.78) !important; }
        .content-wrapper .mb-6 { margin-bottom: calc(1.5rem * 0.78) !important; }
        .content-wrapper .mb-8 { margin-bottom: calc(2rem * 0.78) !important; }
        .content-wrapper .mt-1 { margin-top: calc(0.25rem * 0.78) !important; }
        .content-wrapper .mt-2 { margin-top: calc(0.5rem * 0.78) !important; }
        .content-wrapper .mt-3 { margin-top: calc(0.75rem * 0.78) !important; }
        .content-wrapper .mt-4 { margin-top: calc(1rem * 0.78) !important; }
        .content-wrapper .mt-6 { margin-top: calc(1.5rem * 0.78) !important; }
        .content-wrapper .mt-8 { margin-top: calc(2rem * 0.78) !important; }
        .content-wrapper .mt-12 { margin-top: calc(3rem * 0.78) !important; }
        /* Reduce gaps */
        .content-wrapper .gap-1 { gap: calc(0.25rem * 0.78) !important; }
        .content-wrapper .gap-2 { gap: calc(0.5rem * 0.78) !important; }
        .content-wrapper .gap-3 { gap: calc(0.75rem * 0.78) !important; }
        .content-wrapper .gap-4 { gap: calc(1rem * 0.78) !important; }
        .content-wrapper .gap-6 { gap: calc(1.5rem * 0.78) !important; }
        .content-wrapper .gap-8 { gap: calc(2rem * 0.78) !important; }
        /* Reduce space-y utilities */
        .content-wrapper .space-y-1 > * + * { margin-top: calc(0.25rem * 0.78) !important; }
        .content-wrapper .space-y-2 > * + * { margin-top: calc(0.5rem * 0.78) !important; }
        .content-wrapper .space-y-3 > * + * { margin-top: calc(0.75rem * 0.78) !important; }
        .content-wrapper .space-y-4 > * + * { margin-top: calc(1rem * 0.78) !important; }
        .content-wrapper .space-y-6 > * + * { margin-top: calc(1.5rem * 0.78) !important; }
        .content-wrapper .space-y-8 > * + * { margin-top: calc(2rem * 0.78) !important; }
        /* Skeleton Loading Styles - Modern shimmer effect */
        .skeleton {
            background: linear-gradient(
                90deg,
                #f0f0f0 0%,
                #e0e0e0 50%,
                #f0f0f0 100%
            );
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .skeleton-text {
            height: 1rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 100%; }

        .skeleton-button {
            height: 2.5rem;
            border-radius: 6px;
        }

        /* Progressive content reveal */
        main {
            opacity: 1;
            transition: opacity 0.2s ease-in;
        }

        /* Inline loading indicator for specific actions */
        .inline-loading {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .inline-loading .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 107, 53, 0.1);
            border-top-color: #FF6B35;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
<body class="bg-background min-h-screen">
    <!-- Header Navigation -->
    <header class="bg-surface shadow-card border-b border-border fixed top-0 left-0 right-0 z-50" style="padding-top: max(2rem, env(safe-area-inset-top));">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="../restaurants/restaurant_browse.html" class="flex items-center">
                        <img src="../../public/logos/app_logo.png" alt="HATOD Logo" class="w-10 h-10 mr-3 object-contain">
                        <h1 class="text-xl font-bold text-text-primary">HATOD</h1>
                    </a>
                </div>

                <!-- Navigation -->
                <nav class="hidden md:flex space-x-8">
                    <a href="../restaurants/restaurant_browse.html" class="text-text-secondary hover:text-primary transition-smooth">Browse</a>
                    <a href="order_tracking.html" class="text-text-secondary hover:text-primary transition-smooth">Orders</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8" style="padding-bottom: calc(6rem + max(1rem, env(safe-area-inset-bottom)));">
        <div class="content-wrapper">
        <!-- Breadcrumb -->
        <div class="mb-6">
            <div class="flex items-center space-x-2 text-sm text-text-secondary">
                <a href="../restaurants/restaurant_browse.html" class="hover:text-primary transition-smooth">Browse</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <a href="shopping_cart.html" class="hover:text-primary transition-smooth">Cart</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <span class="text-text-primary">Checkout</span>
            </div>
        </div>

        <!-- Page Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-text-primary mb-2">Checkout</h2>
            <p class="text-text-secondary">Review your order and complete your purchase</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Checkout Form -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Delivery Address -->
                <section class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Delivery Address</h3>
                    <div class="space-y-4">
                        <!-- Manual Address Input -->
                        <div class="space-y-4">
                            <div>
                                <label for="barangay-input" class="block text-sm font-medium text-text-primary mb-2">
                                    Barangay <span class="text-error">*</span>
                                </label>
                                <input type="text" 
                                       id="barangay-input" 
                                       name="barangayInput"
                                       required
                                       placeholder="Enter your barangay"
                                       class="w-full px-4 py-2.5 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-smooth"
                                       autocomplete="address-level2">
                                <p class="text-xs text-text-secondary mt-1">Select or enter your barangay</p>
                            </div>
                            
                            <div>
                                <label for="purok-input" class="block text-sm font-medium text-text-primary mb-2">
                                    Purok <span class="text-error">*</span>
                                </label>
                                <input type="text" 
                                       id="purok-input" 
                                       name="purokInput"
                                       required
                                       placeholder="Enter your purok"
                                       class="w-full px-4 py-2.5 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-smooth"
                                       autocomplete="address-line1">
                                <p class="text-xs text-text-secondary mt-1">Enter your purok or street area</p>
                            </div>
                        </div>
                        
                        <div id="location-status" class="space-y-3">
                            <button id="fetch-location-btn" 
                                    onclick="fetchCustomerLocation()" 
                                    class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary-600 transition-smooth btn-hover flex items-center justify-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                <span>Fetch My Location <span class="text-error">*</span></span>
                            </button>
                            <p class="text-xs text-text-secondary">Location is required for delivery. The rider will use this exact location.</p>
                            
                            <div id="location-loading" class="hidden p-3 bg-blue-50 rounded-lg">
                                <div class="flex items-center space-x-2">
                                    <svg class="animate-spin w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                    <span class="text-blue-600 text-sm font-medium">Fetching your location...</span>
                                </div>
                            </div>

                            <div id="address-display" class="hidden p-4 bg-gray-50 rounded-lg border border-border">
                                <div class="flex items-start space-x-3">
                                    <svg class="w-5 h-5 text-success mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <div class="flex-1">
                                        <p class="text-sm font-medium text-text-primary mb-1">Delivery Location:</p>
                                        <p id="address-text" class="text-sm font-medium text-text-primary break-words mb-2"></p>
                                        <p id="delivery-time-fee" class="text-sm text-text-secondary mb-2"></p>
                                        <p class="text-xs text-text-secondary italic">This is the exact location where the rider will deliver your order.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Barangay Validation Warning -->
                        <div id="barangay-warning" class="hidden p-3 bg-warning-50 border border-warning-200 rounded-lg">
                            <div class="flex items-start space-x-2">
                                <svg class="w-5 h-5 text-warning flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div class="flex-1">
                                    <div class="text-warning font-medium text-sm mb-1">Delivery Not Available</div>
                                    <div class="text-warning text-xs" id="barangay-warning-text"></div>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 bg-success-50 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="text-success text-sm font-medium">Estimated delivery: 30-40 min</span>
                            </div>
                        </div>
                    </div>
                    <!-- Hidden fields for address data -->
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <input type="hidden" id="full-address" name="fullAddress">
                </section>

                <!-- Payment Method -->
                <section class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Payment Method</h3>
                    <div class="space-y-4">
                        <div id="gcash-loading" class="bg-gray-50 border border-border rounded-lg p-4 text-sm text-text-secondary">
                            Loading GCash payment details...
                        </div>

                        <div id="gcash-not-available" class="hidden bg-error-50 border border-error-200 rounded-lg p-4">
                            <p class="font-medium text-error">GCash not available</p>
                            <p class="text-sm text-error-600 mt-1">
                                This restaurant is not yet set up to receive GCash payments. Please choose another restaurant.
                            </p>
                        </div>

                        <!-- GCash Only -->
                        <div id="gcash-payment-option" class="border border-primary rounded-lg bg-primary-50 hidden">
                            <div class="flex items-center p-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-text-primary">GCash (Required)</h3>
                                        <p class="text-text-secondary">You must pay using GCash. Payment goes directly to the restaurant.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- GCash Details -->
                            <div id="gcash-details" class="mx-4 mb-4 px-4 py-3 bg-blue-50 rounded-lg">
                                <p class="text-sm text-blue-800 mb-2">
                                    <strong>GCash Payment Instructions:</strong>
                                </p>
                                <p class="text-sm text-blue-800 mt-2">
                                    ‚Ä¢ Amount to pay: ‚Ç±<span id="gcash-amount">0.00</span><br>
                                    ‚Ä¢ After placing your order, you will be redirected to PayMongo checkout<br>
                                    ‚Ä¢ Complete payment using your GCash account<br>
                                    ‚Ä¢ Payment will be processed securely through PayMongo
                                </p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Order & Delivery Schedule -->
                <section class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Order & Delivery Schedule</h3>
                    <p class="text-sm text-text-secondary mb-4">
                        <em>(Delivery time indicates the start of delivery trips from the Municipality of Claver to different barangays.)</em>
                    </p>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">9:00 AM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïó <strong>Order Time:</strong> 8:00 AM ‚Äì 8:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">10:00 AM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïò <strong>Order Time:</strong> 8:40 AM ‚Äì 9:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">11:00 AM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïô <strong>Order Time:</strong> 9:40 AM ‚Äì 10:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">12:00 noon Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïô <strong>Order Time:</strong> 10:40 AM ‚Äì 11:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">1:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïõ <strong>Order Time:</strong> 11:40 NN ‚Äì 12:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">2:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïê <strong>Order Time:</strong> 12:40 PM ‚Äì 1:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">3:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïë <strong>Order Time:</strong> 1:40 PM ‚Äì 2:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">4:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïí <strong>Order Time:</strong> 2:40 PM ‚Äì 3:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">5:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïì <strong>Order Time:</strong> 3:40 PM ‚Äì 4:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">6:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïî <strong>Order Time:</strong> 4:40 PM ‚Äì 5:40 PM
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-surface rounded-lg shadow-card border border-border sticky top-8">
                    <!-- Restaurant Info -->
                    <div class="p-6 border-b border-border">
                        <div class="flex items-center space-x-3">
                            <img src="https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" 
                                 alt="Pizza Palace" 
                                 class="w-12 h-12 rounded-lg object-cover"
                                 onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                            <div>
                                <h4 class="font-semibold text-text-primary">Pizza Palace</h4>
                                <p class="text-sm text-text-secondary">25-35 min ‚Ä¢ ‚Ç±50.00 delivery</p>
                            </div>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="p-6 border-b border-border">
                        <h3 class="font-semibold text-text-primary mb-4">Order Summary</h3>
                        <div class="space-y-3">
                            <!-- Order items will be loaded here -->
                        </div>
                    </div>

                    <!-- Price Breakdown -->
                    <div class="p-6">
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Subtotal</span>
                                <span class="text-text-primary">‚Ç±0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Delivery fee</span>
                                <span class="text-text-primary">‚Ç±50.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Tax</span>
                                <span class="text-text-primary">‚Ç±0.00</span>
                            </div>
                            <div class="border-t border-border pt-2 mt-2">
                                <div class="flex justify-between">
                                    <span class="font-semibold text-text-primary">Total</span>
                                    <span class="font-bold text-text-primary text-lg">‚Ç±0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Place Order Button -->
                        <button onclick="placeOrder()" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary-600 transition-smooth btn-hover">
                            Place Order
                        </button>

                        <p class="text-xs text-text-secondary text-center mt-3">By placing your order, you agree to our Terms of Service and Privacy Policy</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Number Warning -->
        <div id="mobile-number-warning" class="hidden fixed z-50" style="top: calc(4rem + max(2rem, env(safe-area-inset-top))); left: 0; right: 0; margin: 1rem;">
            <div class="max-w-2xl mx-auto bg-warning-50 border border-warning-200 rounded-lg p-4 shadow-lg">
                <div class="flex items-start space-x-3">
                    <svg class="w-6 h-6 text-warning flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <h4 class="text-warning font-semibold mb-1">Mobile Number Required</h4>
                        <p class="text-warning text-sm mb-3">You need to add your mobile number to your profile before placing an order. This is required for delivery coordination.</p>
                        <a href="customer_profile.html" class="inline-block bg-warning text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-warning-600 transition-smooth">
                            Go to Profile
                        </a>
                    </div>
                    <button onclick="document.getElementById('mobile-number-warning').classList.add('hidden')" class="text-warning hover:text-warning-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Mobile Navigation Bar Spacer (Fixed Footer) -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-background z-30" style="height: calc(3rem + max(1rem, env(safe-area-inset-bottom)));"></div>

    <!-- Footer -->
    <footer class="bg-surface border-t border-border mt-12 pb-20 lg:pb-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <p class="text-text-secondary text-sm">¬© 2025 HATOD. All Rights Reserved.</p>
                <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Privacy Policy</a>
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Terms of Service</a>
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Support</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="../../public/config.js"></script>
    <script src="../../public/js/cache-manager.js"></script>
    <script>
        // API base URL (from config.js - automatically uses Railway URL in mobile apps)
        const API_BASE_URL = window.API_BASE_URL || 'http://localhost:4000/api';

        document.addEventListener('DOMContentLoaded', () => {
            // Page is immediately visible - no full-screen overlay
            loadCheckoutData().catch(error => {
                console.error('Error loading checkout data:', error);
            });
        });

        // Mapbox access token for reverse geocoding
        const MAPBOX_TOKEN = 'pk.eyJ1Ijoia3JpZGxsbCIsImEiOiJjbWljdzdmYXUwb3I1MmpwcTJyNWVsN252In0.2lBD_f8wyFrpViRg8n6cOw';
        let allowedBarangays = [];
        let selectedBarangay = '';
        
        // Load allowed barangays on page load
        async function loadAllowedBarangays() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_BASE_URL}/delivery-fees/tiers`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    allowedBarangays = Object.keys(data.data || {});
                    console.log('Allowed barangays loaded:', allowedBarangays);
                    
                    // Populate barangay autocomplete
                    populateBarangayOptions();
                }
            } catch (error) {
                console.error('Error loading allowed barangays:', error);
            }
        }
        
        // Helper function to normalize barangay name (remove "barangay" prefix for comparison)
        function normalizeBarangayName(barangay) {
            if (!barangay) return '';
            return barangay.trim()
                .replace(/^barangay\s+/i, '')
                .replace(/^brgy\.?\s+/i, '')
                .trim();
        }
        
        // Helper function to check if a barangay matches any allowed barangay (using normalized comparison)
        function isBarangayAllowed(barangay, allowedList) {
            if (!barangay || allowedList.length === 0) return false;
            const normalized = normalizeBarangayName(barangay);
            return allowedList.some(allowed => {
                const normalizedAllowed = normalizeBarangayName(allowed);
                return normalized.toLowerCase() === normalizedAllowed.toLowerCase();
            });
        }
        
        // Helper function to find the matching allowed barangay (returns the original format from allowed list)
        function findMatchingBarangay(barangay, allowedList) {
            if (!barangay || allowedList.length === 0) return null;
            const normalized = normalizeBarangayName(barangay);
            const match = allowedList.find(allowed => {
                const normalizedAllowed = normalizeBarangayName(allowed);
                return normalized.toLowerCase() === normalizedAllowed.toLowerCase();
            });
            return match || null;
        }
        
        // Populate barangay input with datalist for autocomplete
        function populateBarangayOptions() {
            const barangayInput = document.getElementById('barangay-input');
            if (!barangayInput || allowedBarangays.length === 0) return;
            
            // Create or get datalist
            let datalist = document.getElementById('barangay-options');
            if (!datalist) {
                datalist = document.createElement('datalist');
                datalist.id = 'barangay-options';
                barangayInput.setAttribute('list', 'barangay-options');
                document.body.appendChild(datalist);
            }
            
            // Clear existing options
            datalist.innerHTML = '';
            
            // Add options
            allowedBarangays.forEach(barangay => {
                const option = document.createElement('option');
                option.value = barangay;
                datalist.appendChild(option);
            });
        }
        
        // Validate deliverable area based on fetched location
        async function validateDeliverableArea(fetchedAddress) {
            if (!fetchedAddress || allowedBarangays.length === 0) {
                return { isValid: false, message: 'Could not validate delivery area' };
            }
            
            // Try to extract barangay from the fetched address
            // Mapbox response may have barangay in context or in place_name
            let extractedBarangay = null;
            
            // Check if fetchedAddress is a Mapbox feature object
            if (typeof fetchedAddress === 'object' && fetchedAddress.context) {
                // Try to find barangay in context
                const context = fetchedAddress.context;
                // Look for neighborhood or place that might be barangay
                const neighborhood = context.find(c => c.id.startsWith('neighborhood'))?.text;
                const place = context.find(c => c.id.startsWith('place'))?.text;
                
                // Try neighborhood first, then place
                extractedBarangay = neighborhood || place;
            } else if (typeof fetchedAddress === 'string') {
                // Parse from place_name string
                // Common formats: "Barangay Name, City, Province" or "Name, City"
                const addressParts = fetchedAddress.split(',').map(p => p.trim());
                for (const part of addressParts) {
                    // Check if any part matches an allowed barangay
                    if (isBarangayAllowed(part, allowedBarangays)) {
                        extractedBarangay = part;
                        break;
                    }
                }
            }
            
            // If we found a barangay, validate it
            if (extractedBarangay) {
                if (isBarangayAllowed(extractedBarangay, allowedBarangays)) {
                    return { isValid: true, barangay: findMatchingBarangay(extractedBarangay, allowedBarangays) };
                } else {
                    return {
                        isValid: false,
                        message: `Delivery is not available to ${extractedBarangay}. We currently deliver to: ${allowedBarangays.join(', ')}.`
                    };
                }
            }
            
            // If we couldn't extract barangay, we'll be lenient and allow it
            // The backend will do final validation
            return { isValid: true, barangay: null };
        }
        
        // Validate manually entered barangay (for delivery fee calculation only)
        function validateBarangay() {
            const barangayInput = document.getElementById('barangay-input');
            const purokInput = document.getElementById('purok-input');
            const barangayWarning = document.getElementById('barangay-warning');
            const warningText = document.getElementById('barangay-warning-text');
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            const fullAddress = document.getElementById('full-address').value.trim();
            
            if (!barangayInput || !purokInput) return false;
            
            const enteredBarangay = barangayInput.value.trim();
            const enteredPurok = purokInput.value.trim();
            
            // Check if location is fetched (required)
            if (!latitude || !longitude || !fullAddress) {
                if (barangayWarning) {
                    barangayWarning.classList.add('hidden');
                }
                selectedBarangay = '';
                disablePlaceOrder('Please fetch your location first');
                return false;
            }
            
            // Check if both fields are filled
            if (!enteredBarangay || !enteredPurok) {
                if (barangayWarning) {
                    barangayWarning.classList.add('hidden');
                }
                selectedBarangay = '';
                disablePlaceOrder('Please enter both barangay and purok');
                return false;
            }
            
            // Check if barangay is in allowed list (using normalized comparison for delivery fee)
            const matchingBarangay = findMatchingBarangay(enteredBarangay, allowedBarangays);
            if (!matchingBarangay) {
                if (barangayWarning) {
                    let warningMessage = 'The entered barangay is not in our delivery area. ';
                    if (allowedBarangays.length > 0) {
                        warningMessage += `We currently deliver to: ${allowedBarangays.join(', ')}.`;
                    } else {
                        warningMessage += 'Please contact support for delivery availability.';
                    }
                    if (warningText) {
                        warningText.textContent = warningMessage;
                    }
                    barangayWarning.classList.remove('hidden');
                }
                selectedBarangay = '';
                disablePlaceOrder('Delivery not available to your location');
                return false;
            }
            
            // Valid barangay and location (use the matching barangay from allowed list for delivery fee)
            selectedBarangay = matchingBarangay;
            if (barangayWarning) {
                barangayWarning.classList.add('hidden');
            }
            
            // Update delivery fee
            updateDeliveryFee(selectedBarangay);
            
            // Enable place order button
            enablePlaceOrder();
            
            return true;
        }

        // Fetch customer location when button is clicked
        async function fetchCustomerLocation() {
            const locationLoading = document.getElementById('location-loading');
            const fetchBtn = document.getElementById('fetch-location-btn');
            const addressDisplay = document.getElementById('address-display');
            const barangayWarning = document.getElementById('barangay-warning');
            
            // Hide previous results
            addressDisplay.classList.add('hidden');
            barangayWarning.classList.add('hidden');
            
            // Load allowed barangays if not loaded
            if (allowedBarangays.length === 0) {
                await loadAllowedBarangays();
            }
            
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser. Please use a different browser.');
                return;
            }

            // Show loading state
            if (locationLoading) locationLoading.classList.remove('hidden');
            if (fetchBtn) {
                fetchBtn.disabled = true;
                fetchBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }

            try {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        console.log('Location fetched:', { latitude, longitude });
                        
                        // Store coordinates in hidden fields
                        document.getElementById('latitude').value = latitude;
                        document.getElementById('longitude').value = longitude;
                        
                        // Reverse geocode to get address and extract barangay
                        await reverseGeocode(longitude, latitude);
                        
                        // Hide loading indicator
                        if (locationLoading) locationLoading.classList.add('hidden');
                        if (fetchBtn) {
                            fetchBtn.disabled = false;
                            fetchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    },
                    async (error) => {
                        console.error('Error fetching location:', error);
                        
                        // Hide loading indicator
                        if (locationLoading) locationLoading.classList.add('hidden');
                        if (fetchBtn) {
                            fetchBtn.disabled = false;
                            fetchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                        
                        let errorMessage = 'Failed to fetch location. ';
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage += 'Please allow location access and try again.';
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage += 'Location request timed out. Please try again.';
                        } else {
                            errorMessage += 'Please try again.';
                        }
                        alert(errorMessage);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } catch (error) {
                console.error('Error in fetchCustomerLocation:', error);
                if (locationLoading) locationLoading.classList.add('hidden');
                if (fetchBtn) {
                    fetchBtn.disabled = false;
                    fetchBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                alert('An error occurred while fetching location. Please try again.');
            }
        }

        // Reverse geocode coordinates to get full address (for rider navigation)
        async function reverseGeocode(lng, lat) {
            try {
                const response = await fetch(
                    `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${MAPBOX_TOKEN}&country=PH`
                );
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    const placeName = feature.place_name || '';
                    
                    // Store full address for rider navigation
                    document.getElementById('full-address').value = placeName;
                    
                    // Display full exact address
                    const addressDisplay = document.getElementById('address-display');
                    const addressText = document.getElementById('address-text');
                    const deliveryTimeFee = document.getElementById('delivery-time-fee');
                    
                    if (addressText) {
                        addressText.textContent = placeName;
                    }
                    
                    // Show delivery time and fee if available
                    if (deliveryTimeFee) {
                        // Get delivery fee if already calculated
                        const deliveryFeeElement = document.querySelector('#orderSummary .text-sm.text-text-secondary');
                        if (deliveryFeeElement && deliveryFeeElement.textContent.includes('‚Ç±')) {
                            const feeMatch = deliveryFeeElement.textContent.match(/‚Ç±([\d.]+)/);
                            if (feeMatch) {
                                deliveryTimeFee.textContent = `25-35 min ‚Ä¢ ‚Ç±${feeMatch[1]} delivery`;
                            } else {
                                deliveryTimeFee.textContent = '25-35 min ‚Ä¢ Delivery fee will be calculated';
                            }
                        } else {
                            deliveryTimeFee.textContent = '25-35 min ‚Ä¢ Delivery fee will be calculated';
                        }
                    }
                    
                    // Show address display
                    if (addressDisplay) {
                        addressDisplay.classList.remove('hidden');
                    }
                    
                    console.log('Location fetched and displayed:', placeName);
                    
                    // Validate deliverable area based on fetched location
                    const deliverableValidation = await validateDeliverableArea(feature);
                    if (!deliverableValidation.isValid) {
                        // Show error and disable place order
                        const barangayWarning = document.getElementById('barangay-warning');
                        const warningText = document.getElementById('barangay-warning-text');
                        if (barangayWarning && warningText) {
                            warningText.textContent = deliverableValidation.message;
                            barangayWarning.classList.remove('hidden');
                        }
                        disablePlaceOrder('Delivery not available to your location');
                        return;
                    } else {
                        // Hide warning if validation passes
                        const barangayWarning = document.getElementById('barangay-warning');
                        if (barangayWarning) {
                            barangayWarning.classList.add('hidden');
                        }
                    }
                    
                    // Trigger validation to check if barangay/purok are entered and update delivery fee
                    validateBarangay();
                } else {
                    console.error('No address found for coordinates');
                    alert('Could not find address for your location. Please try again.');
                }
            } catch (error) {
                console.error('Error reverse geocoding:', error);
                alert('Error getting address. Please try again.');
            }
        }

        function disablePlaceOrder(reason) {
            const placeOrderBtn = document.querySelector('button[onclick="placeOrder()"]');
            if (placeOrderBtn) {
                placeOrderBtn.disabled = true;
                placeOrderBtn.classList.add('opacity-50', 'cursor-not-allowed');
                placeOrderBtn.classList.remove('btn-hover');
                placeOrderBtn.title = reason || 'Delivery not available';
            }
        }

        function enablePlaceOrder() {
            const placeOrderBtn = document.querySelector('button[onclick="placeOrder()"]');
            if (placeOrderBtn) {
                placeOrderBtn.disabled = false;
                placeOrderBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                placeOrderBtn.classList.add('btn-hover');
                placeOrderBtn.title = '';
            }
        }

        // Set loading state on place order button(s)
        function setPlaceOrderLoading(isLoading) {
            const placeOrderButtons = document.querySelectorAll('button[onclick="placeOrder()"]');
            placeOrderButtons.forEach(btn => {
                if (isLoading) {
                    // Store original text
                    if (!btn.dataset.originalText) {
                        btn.dataset.originalText = btn.innerHTML;
                    }
                    // Show spinner and disable button
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('btn-hover');
                    btn.innerHTML = `
                        <span class="inline-flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Processing...
                        </span>
                    `;
                } else {
                    // Restore original text and state
                    if (btn.dataset.originalText) {
                        btn.innerHTML = btn.dataset.originalText;
                        delete btn.dataset.originalText;
                    }
                    // Re-enable if it was enabled before (check if it should be enabled)
                    const shouldBeEnabled = !btn.classList.contains('opacity-50') || btn.classList.contains('btn-hover');
                    if (shouldBeEnabled) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                        btn.classList.add('btn-hover');
                    }
                }
            });
        }

        function showMobileNumberWarning() {
            const warning = document.getElementById('mobile-number-warning');
            if (warning) {
                warning.classList.remove('hidden');
            }
        }

        async function loadCheckoutData() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Please log in to continue');
                    window.location.href = '../login.html';
                    return;
                }

                // Decode JWT to get customer ID (simple decode, not secure)
                const payload = JSON.parse(atob(token.split('.')[1]));
                const customerId = payload.sub;

                // Check if customer has mobile number first
                let hasMobileNumber = true;
                const profileResponse = await fetch(`${API_BASE_URL}/customers/${customerId}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    const profile = profileData.data;
                    
                    if (!profile.phone || profile.phone.trim() === '') {
                        hasMobileNumber = false;
                        // Disable place order button and show warning
                        disablePlaceOrder('Please add your mobile number in your profile');
                        showMobileNumberWarning();
                    }
                } else {
                    console.warn('Failed to load customer profile, continuing anyway');
                }

                console.log('[Checkout] Loading cart data...');
                // Load cart data with cache-first strategy
                const cacheKey = `cart_${token.split('.')[1]}`;
                const cartResult = await window.CacheManager.fetchWithCache(
                    cacheKey,
                    async () => {
                        const cartResponse = await fetch(`${API_BASE_URL}/cart`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (!cartResponse.ok) {
                            const errorData = await cartResponse.json().catch(() => ({ message: 'Failed to load cart' }));
                            throw new Error(errorData.message || 'Failed to load cart');
                        }

                        const cartData = await cartResponse.json();
                        return cartData.data || [];
                    },
                    {
                        ttl: 1 * 60 * 1000, // 1 minute TTL for checkout cart
                        forceRefresh: false,
                        onCached: (cachedCart) => {
                            console.log('[Checkout] Using cached cart data');
                        }
                    }
                );
                const cart = cartResult.data;
                console.log('[Checkout] Cart data loaded:', cart);

                if (cart.length === 0) {
                    alert('Your cart is empty');
                    window.location.href = 'shopping_cart.html';
                    return;
                }

                // Load allowed barangays
                await loadAllowedBarangays();

                // Update UI with real data - support multiple restaurants
                updateRestaurantInfo(cart);
                await updateOrderSummary(cart);

                // Check if restaurant is open (after order summary is created)
                await checkRestaurantStatus(cart);

                // Load payment methods (GCash if available)
                await loadPaymentMethods(cart);
                
                // Initially disable place order button until location is fetched and barangay/purok are entered (only if mobile number exists and restaurant is open)
                if (hasMobileNumber) {
                    disablePlaceOrder('Please fetch your location and enter your barangay and purok');
                }
                
                // Add event listeners for barangay and purok inputs
                const barangayInput = document.getElementById('barangay-input');
                const purokInput = document.getElementById('purok-input');
                
                if (barangayInput) {
                    barangayInput.addEventListener('input', validateBarangay);
                    barangayInput.addEventListener('blur', validateBarangay);
                }
                
                if (purokInput) {
                    purokInput.addEventListener('input', validateBarangay);
                    purokInput.addEventListener('blur', validateBarangay);
                }

                // Data loaded - page is already visible

            } catch (error) {
                console.error('[Checkout] Error loading checkout data:', error);
                alert('Failed to load checkout data: ' + error.message);
            }
        }

        async function checkRestaurantStatus(cart) {
            if (cart.length === 0) return;

            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                // Get unique restaurants from cart
                const restaurantIds = [...new Set(cart.map(item => item.restaurantId))];
                const closedRestaurants = [];

                // Check status of all restaurants
                for (const restaurantId of restaurantIds) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/restaurants/${restaurantId}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const restaurantData = await response.json();
                            const restaurant = restaurantData.data;
                            
                            if (!restaurant.isOpen) {
                                closedRestaurants.push({
                                    id: restaurantId,
                                    name: restaurant.name || cart.find(item => item.restaurantId === restaurantId)?.restaurantName || 'Restaurant'
                                });
                            }
                        }
                    } catch (error) {
                        console.error(`Error checking restaurant ${restaurantId}:`, error);
                    }
                }

                // If any restaurant is closed, disable checkout and show warning
                if (closedRestaurants.length > 0) {
                    disablePlaceOrder('One or more restaurants are currently closed');
                    
                    // Show warning message with list of closed restaurants
                    const warningDiv = document.createElement('div');
                    warningDiv.className = 'bg-error-50 border border-error-200 rounded-lg p-4 mb-4';
                    
                    const restaurantList = closedRestaurants.map(r => r.name).join(', ');
                    const isMultiple = closedRestaurants.length > 1;
                    
                    warningDiv.innerHTML = `
                        <div class="flex items-start space-x-2">
                            <svg class="w-5 h-5 text-error flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <div class="flex-1">
                                <p class="font-medium text-error">${isMultiple ? 'Restaurants are Closed' : 'Restaurant is Closed'}</p>
                                <p class="text-sm text-error-600 mt-1">
                                    ${isMultiple 
                                        ? `The following restaurants in your cart are currently closed: ${restaurantList}. You cannot place an order when any restaurant is closed. Please remove items from closed restaurants or try again when they are open.`
                                        : `${restaurantList} is currently closed. You cannot place an order when the restaurant is closed. Please try again when the restaurant is open.`}
                                </p>
                            </div>
                        </div>
                    `;
                    
                    // Insert warning in the order summary container
                    const orderSummaryContainer = document.querySelector('.lg\\:col-span-1');
                    if (orderSummaryContainer) {
                        // Find the first restaurant card or place order card
                        const firstCard = orderSummaryContainer.querySelector('.bg-surface.rounded-lg');
                        if (firstCard) {
                            // Insert before the first card
                            orderSummaryContainer.insertBefore(warningDiv, firstCard);
                        } else {
                            // Fallback: append to container
                            orderSummaryContainer.insertBefore(warningDiv, orderSummaryContainer.firstChild);
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking restaurant status:', error);
                // Don't block checkout if we can't check status
            }
        }

        // -----------------------------
        // GCash helpers (best-effort)
        // -----------------------------
        window.__HATOD_GCASH__ = window.__HATOD_GCASH__ || {
            mobileNumber: null,
            amount: null
        };

        async function copyToClipboard(text) {
            if (!text) return false;
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                    return true;
                }
            } catch (_) {
                // fall back below
            }

            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                const ok = document.execCommand('copy');
                document.body.removeChild(textarea);
                return ok;
            } catch (_) {
                return false;
            }
        }

        /**
         * Create PayMongo source and redirect to payment
         */
        async function redirectToPaymongoPayment(orderId, amount) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Please log in to continue');
                    window.location.href = '../login.html';
                    return;
                }

                // Create PayMongo payment source
                const response = await fetch(`${API_BASE_URL}/payments/create-source`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        orderId: orderId,
                        amount: amount,
                        redirectSuccess: `${window.location.origin}/pages/customers/payment_confirmation.html?orderId=${orderId}&status=success`,
                        redirectFailed: `${window.location.origin}/pages/customers/payment_confirmation.html?orderId=${orderId}&status=failed`
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Failed to create payment' }));
                    throw new Error(errorData.message || 'Failed to create payment');
                }

                const result = await response.json();
                const checkoutUrl = result.data.checkoutUrl;

                if (checkoutUrl) {
                    // Redirect to PayMongo checkout
                    window.location.href = checkoutUrl;
                } else {
                    throw new Error('No checkout URL received from PayMongo');
                }
            } catch (error) {
                console.error('Error creating PayMongo payment:', error);
                alert('Failed to initiate payment: ' + error.message);
                setPlaceOrderLoading(false);
            }
        }

        function openGcashApp() {
            // Note: Most wallets don't allow pre-filling recipient/amount via public deep links.
            // We open the GCash app (if installed) and provide copy buttons for details.
            const hint = document.getElementById('gcash-open-hint');
            if (hint) hint.classList.add('hidden');

            const ua = navigator.userAgent || '';
            const isAndroid = /Android/i.test(ua);
            const isIOS = /iPhone|iPad|iPod/i.test(ua);

            // Best-effort launch URLs
            const androidIntent = 'intent://#Intent;scheme=gcash;package=com.globe.gcash.android;end';
            const iosScheme = 'gcash://';
            const webFallback = 'https://www.gcash.com/';

            // Show hint after a short delay in case launch fails
            window.setTimeout(() => {
                const h = document.getElementById('gcash-open-hint');
                if (h) h.classList.remove('hidden');
            }, 1400);

            try {
                if (isAndroid) {
                    window.location.href = androidIntent;
                } else if (isIOS) {
                    window.location.href = iosScheme;
                } else {
                    window.open(webFallback, '_blank', 'noopener');
                }
            } catch (error) {
                console.error('Failed to open GCash:', error);
                if (hint) hint.classList.remove('hidden');
            }
        }

        // Load payment methods based on restaurant GCash settings
        async function loadPaymentMethods(cart) {
            if (cart.length === 0) return;

            try {
                const gcashLoading = document.getElementById('gcash-loading');
                const gcashNotAvailable = document.getElementById('gcash-not-available');
                const gcashOption = document.getElementById('gcash-payment-option');

                const token = localStorage.getItem('authToken');
                if (!token) return;

                // Get unique restaurants from cart
                const restaurantIds = [...new Set(cart.map(item => item.restaurantId))];

                // GCash-only checkout currently supports one restaurant at a time
                if (restaurantIds.length !== 1) {
                    if (gcashLoading) gcashLoading.classList.add('hidden');
                    if (gcashOption) gcashOption.classList.add('hidden');
                    if (gcashNotAvailable) {
                        gcashNotAvailable.classList.remove('hidden');
                        gcashNotAvailable.querySelector('.font-medium').textContent = 'Multi-restaurant checkout not supported';
                        gcashNotAvailable.querySelector('.text-sm').textContent =
                            'Please checkout one restaurant at a time when using GCash-only payments.';
                    }
                    window.__HATOD_GCASH__.isAvailable = false;
                    disablePlaceOrder('GCash checkout supports one restaurant only');
                    return;
                }
                
                // For now, check the first restaurant (for single restaurant orders)
                // For multi-restaurant orders, we'd need to handle this differently
                if (restaurantIds.length === 1) {
                    const restaurantId = restaurantIds[0];
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/restaurants/${restaurantId}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const restaurantData = await response.json();
                            const restaurant = restaurantData.data;

                            if (gcashLoading) gcashLoading.classList.add('hidden');

                            // GCash is required
                            if (!restaurant.gcashEnabled) {
                                if (gcashOption) gcashOption.classList.add('hidden');
                                if (gcashNotAvailable) gcashNotAvailable.classList.remove('hidden');
                                window.__HATOD_GCASH__.isAvailable = false;
                                disablePlaceOrder('Restaurant does not accept GCash');
                                return;
                            }

                            // Show GCash details
                            if (gcashNotAvailable) gcashNotAvailable.classList.add('hidden');
                            if (gcashOption) gcashOption.classList.remove('hidden');
                            window.__HATOD_GCASH__.isAvailable = true;

                            // PayMongo handles payment flow - no need for restaurant GCash details in checkout
                        }
                    } catch (error) {
                        console.error('Error loading restaurant GCash settings:', error);
                        if (gcashLoading) gcashLoading.classList.add('hidden');
                        if (gcashOption) gcashOption.classList.add('hidden');
                        if (gcashNotAvailable) gcashNotAvailable.classList.remove('hidden');
                        window.__HATOD_GCASH__.isAvailable = false;
                        disablePlaceOrder('Failed to load GCash settings');
                    }
                }
            } catch (error) {
                console.error('Error loading payment methods:', error);
            }
        }

        function updateRestaurantInfo(cart) {
            if (cart.length === 0) return;

            // Group items by restaurant
            const restaurants = {};
            cart.forEach(item => {
                if (!restaurants[item.restaurantId]) {
                    restaurants[item.restaurantId] = {
                        id: item.restaurantId,
                        name: item.restaurantName || 'Restaurant',
                        imageUrl: item.restaurantImageUrl,
                        items: []
                    };
                }
                restaurants[item.restaurantId].items.push(item);
            });

            // If single restaurant, update the existing info section
            const restaurantIds = Object.keys(restaurants);
            if (restaurantIds.length === 1) {
                const firstItem = cart[0];
                const restaurantLogo = document.querySelector('img[alt="Pizza Palace"]');
                const restaurantName = document.querySelector('h4.font-semibold.text-text-primary');
                const deliveryInfo = document.querySelector('p.text-sm.text-text-secondary');

                if (restaurantLogo) restaurantLogo.src = firstItem.restaurantImageUrl || restaurantLogo.src;
                if (restaurantName) restaurantName.textContent = firstItem.restaurantName || 'Restaurant';
                if (deliveryInfo) deliveryInfo.textContent = '25-35 min ‚Ä¢ ‚Ç±50 delivery';
            }
            // For multiple restaurants, the summary will be updated in updateOrderSummary
        }

        async function updateOrderSummary(cart) {
            // Group items by restaurant
            const restaurants = {};
            cart.forEach(item => {
                if (!restaurants[item.restaurantId]) {
                    restaurants[item.restaurantId] = {
                        id: item.restaurantId,
                        name: item.restaurantName || 'Restaurant',
                        imageUrl: item.restaurantImageUrl,
                        items: []
                    };
                }
                restaurants[item.restaurantId].items.push(item);
            });

            const restaurantIds = Object.keys(restaurants);
            const orderSummaryContainer = document.querySelector('.lg\\:col-span-1');
            
            if (!orderSummaryContainer) {
                console.error('Order summary container not found');
                return;
            }

            // Clear existing content
            orderSummaryContainer.innerHTML = '';

            // Create summary for each restaurant
            let grandTotal = 0;
            restaurantIds.forEach((restaurantId, index) => {
                const restaurant = restaurants[restaurantId];
                let subtotal = 0;

                // Calculate subtotal for this restaurant
                restaurant.items.forEach(item => {
                    const price = item.variantPrice ? parseFloat(item.variantPrice) : (item.price ? parseFloat(item.price) : 0);
                    const quantity = item.quantity || 1;
                    const itemTotal = (isNaN(price) ? 0 : price) * (isNaN(quantity) ? 1 : quantity);
                    subtotal += isNaN(itemTotal) ? 0 : itemTotal;
                });

                const deliveryFee = 0; // Will be calculated after address validation
                const total = subtotal + deliveryFee;
                grandTotal += total;

                // Create restaurant summary card
                const restaurantCard = document.createElement('div');
                restaurantCard.className = 'bg-surface rounded-lg shadow-card border border-border sticky top-8' + (index > 0 ? ' mt-6' : '');
                
                restaurantCard.innerHTML = `
                    <!-- Restaurant Info -->
                    <div class="p-6 border-b border-border">
                        <div class="flex items-center space-x-3">
                            <img src="${restaurant.imageUrl || 'https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'}" 
                                 alt="${restaurant.name}" 
                                 class="w-12 h-12 rounded-lg object-cover"
                                 onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                            <div>
                                <h4 class="font-semibold text-text-primary">${restaurant.name}</h4>
                                <p class="text-sm text-text-secondary">25-35 min ‚Ä¢ ‚Ç±50.00 delivery</p>
                            </div>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="p-6 border-b border-border">
                        <h3 class="font-semibold text-text-primary mb-4">Order Summary</h3>
                        <div class="space-y-3" data-restaurant-id="${restaurantId}">
                            ${restaurant.items.map(item => {
                                const price = item.variantPrice ? parseFloat(item.variantPrice) : (item.price ? parseFloat(item.price) : 0);
                                const quantity = item.quantity || 1;
                                const itemTotal = (isNaN(price) ? 0 : price) * (isNaN(quantity) ? 1 : quantity);
                                const variantInfo = item.variantName ? ` (${item.variantName})` : '';
                                return `
                                    <div class="flex justify-between text-sm">
                                        <span class="text-text-secondary">${item.name}${variantInfo} x${item.quantity}</span>
                                        <span class="text-text-primary">‚Ç±${itemTotal.toFixed(2)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Price Breakdown -->
                    <div class="p-6" data-restaurant-id="${restaurantId}">
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Subtotal</span>
                                <span class="text-text-primary restaurant-subtotal">‚Ç±${subtotal.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Delivery fee</span>
                                <span class="text-text-primary restaurant-delivery-fee">‚Ç±0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Tax</span>
                                <span class="text-text-primary">‚Ç±0.00</span>
                            </div>
                            <div class="border-t border-border pt-2 mt-2">
                                <div class="flex justify-between">
                                    <span class="font-semibold text-text-primary">Total</span>
                                    <span class="font-bold text-text-primary text-lg restaurant-total">‚Ç±${total.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                orderSummaryContainer.appendChild(restaurantCard);
            });

            // Add single place order button at the bottom if multiple restaurants
            if (restaurantIds.length > 1) {
                const placeOrderCard = document.createElement('div');
                placeOrderCard.className = 'bg-surface rounded-lg shadow-card border border-border mt-6';
                placeOrderCard.innerHTML = `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-semibold text-text-primary text-lg">Grand Total</span>
                            <span class="font-bold text-text-primary text-xl" id="grand-total">‚Ç±${grandTotal.toFixed(2)}</span>
                        </div>
                        <button onclick="placeOrder()" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary-600 transition-smooth btn-hover">
                            Place All Orders
                        </button>
                        <p class="text-xs text-text-secondary text-center mt-3">You will place ${restaurantIds.length} separate order${restaurantIds.length > 1 ? 's' : ''} - one for each restaurant</p>
                    </div>
                `;
                orderSummaryContainer.appendChild(placeOrderCard);
            } else {
                // Single restaurant - add place order button to the restaurant card
                const restaurantCard = orderSummaryContainer.querySelector('.bg-surface');
                if (restaurantCard) {
                    const priceBreakdown = restaurantCard.querySelector('.p-6[data-restaurant-id]');
                    if (priceBreakdown) {
                        priceBreakdown.innerHTML += `
                            <button onclick="placeOrder()" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary-600 transition-smooth btn-hover">
                                Place Order
                            </button>
                            <p class="text-xs text-text-secondary text-center mt-3">By placing your order, you agree to our Terms of Service and Privacy Policy</p>
                        `;
                    }
                }
            }

            // Update cash payment instructions
            // Update GCash payment amount
            const gcashAmountElement = document.getElementById('gcash-amount');
            if (gcashAmountElement) {
                gcashAmountElement.textContent = grandTotal.toFixed(2);
            }

            // Keep amount available for copy button
            window.__HATOD_GCASH__ = window.__HATOD_GCASH__ || {};
            window.__HATOD_GCASH__.amount = grandTotal.toFixed(2);
            
            // Update delivery info if it exists (for single restaurant view)
            const deliveryInfo = document.querySelector('p.text-sm.text-text-secondary');
            if (deliveryInfo) {
                deliveryInfo.textContent = '25-35 min ‚Ä¢ Delivery fee calculated after address confirmation';
            }
            
            // Calculate and store subtotal for later use (sum of all restaurant subtotals)
            let validSubtotal = 0;
            restaurantIds.forEach(restaurantId => {
                const restaurant = restaurants[restaurantId];
                restaurant.items.forEach(item => {
                    const price = item.variantPrice ? parseFloat(item.variantPrice) : (item.price ? parseFloat(item.price) : 0);
                    const quantity = item.quantity || 1;
                    const itemTotal = (isNaN(price) ? 0 : price) * (isNaN(quantity) ? 1 : quantity);
                    validSubtotal += isNaN(itemTotal) ? 0 : itemTotal;
                });
            });
            
            // Store subtotal for later use
            window.checkoutSubtotal = validSubtotal;
        }

        async function updateDeliveryFee(barangay) {
            try {
                const subtotal = window.checkoutSubtotal || 0;
                
                if (!barangay) {
                    console.error('No barangay provided for delivery fee calculation');
                    return;
                }

                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.error('No auth token found');
                    return;
                }

                // Calculate delivery fee based on validated barangay and order amount
                const feeResponse = await fetch(`${API_BASE_URL}/delivery-fees/calculate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        barangay: barangay,
                        orderAmount: subtotal
                    })
                });

                if (!feeResponse.ok) {
                    throw new Error('Failed to calculate delivery fee');
                }

                const feeData = await feeResponse.json();
                const deliveryFee = parseFloat(feeData.data.deliveryFee) || 0;

                // Find price elements
                const priceBreakdown = document.querySelector('.p-6:not(.border-b) .space-y-2') ||
                                      document.querySelector('.lg\\:col-span-1 .space-y-2');
                
                if (!priceBreakdown) {
                    console.error('Price breakdown container not found');
                    return;
                }

                const priceElements = priceBreakdown.querySelectorAll('.flex.justify-between.text-sm span:last-child');
                const deliveryFeeElement = priceElements[1]; // Delivery fee
                const totalElement = document.querySelector('.border-t.border-border .flex.justify-between span:last-child');

                // Get current subtotal
                const subtotalElement = priceElements[0];
                const currentSubtotalText = subtotalElement ? subtotalElement.textContent : '‚Ç±0.00';
                const currentSubtotal = parseFloat(currentSubtotalText.replace('‚Ç±', '').replace(',', '')) || subtotal;

                // Calculate new total
                const validSubtotal = isNaN(currentSubtotal) ? 0 : currentSubtotal;
                const validDeliveryFee = isNaN(deliveryFee) ? 0 : deliveryFee;
                const total = validSubtotal + validDeliveryFee;

                // Update UI
                if (deliveryFeeElement) {
                    deliveryFeeElement.textContent = `‚Ç±${validDeliveryFee.toFixed(2)}`;
                }
                if (totalElement) {
                    totalElement.textContent = `‚Ç±${total.toFixed(2)}`;
                }

                // Update GCash payment amount
                const gcashAmountElement = document.getElementById('gcash-amount');
                if (gcashAmountElement) {
                    gcashAmountElement.textContent = total.toFixed(2);
                }

                // Keep amount available for copy button
                window.__HATOD_GCASH__ = window.__HATOD_GCASH__ || {};
                window.__HATOD_GCASH__.amount = total.toFixed(2);

                // Update delivery info in order summary
                const deliveryInfo = document.querySelector('p.text-sm.text-text-secondary');
                if (deliveryInfo) {
                    deliveryInfo.textContent = `25-35 min ‚Ä¢ ‚Ç±${validDeliveryFee.toFixed(2)} delivery`;
                }
                
                // Update delivery time and fee in address display if visible
                const deliveryTimeFee = document.getElementById('delivery-time-fee');
                if (deliveryTimeFee) {
                    deliveryTimeFee.textContent = `25-35 min ‚Ä¢ ‚Ç±${validDeliveryFee.toFixed(2)} delivery`;
                }

                console.log('Delivery fee updated:', { barangay, deliveryFee, subtotal, total });
            } catch (error) {
                console.error('Error calculating delivery fee:', error);
                // Don't show alert, just log error - delivery fee will remain 0
            }
        }

        async function placeOrder() {
            // Set loading state
            setPlaceOrderLoading(true);
            
            try {
                if (window.__HATOD_GCASH__ && window.__HATOD_GCASH__.isAvailable === false) {
                    setPlaceOrderLoading(false);
                    alert('This restaurant does not accept GCash payments. Please choose another restaurant.');
                    return;
                }

                const token = localStorage.getItem('authToken');
                if (!token) {
                    setPlaceOrderLoading(false);
                    alert('Please log in to continue');
                    window.location.href = '../login.html';
                    return;
                }

                // Decode JWT to get customer ID
                const payload = JSON.parse(atob(token.split('.')[1]));
                const customerId = payload.sub;

                // Validate mobile number before proceeding
                const profileResponse = await fetch(`${API_BASE_URL}/customers/${customerId}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    const profile = profileData.data;
                    
                    if (!profile.phone || profile.phone.trim() === '') {
                        setPlaceOrderLoading(false);
                        const addMobile = confirm(
                            'You need to add your mobile number to your profile before placing an order.\n\n' +
                            'Would you like to go to your profile page to add it now?'
                        );
                        if (addMobile) {
                            window.location.href = 'customer_profile.html';
                        }
                        return;
                    }
                } else {
                    // If we can't check profile, show warning but allow to continue
                    console.warn('Could not verify mobile number, but allowing order to proceed');
                }

                // Get location data (required)
                const fullAddress = document.getElementById('full-address').value.trim();
                const latitude = document.getElementById('latitude').value;
                const longitude = document.getElementById('longitude').value;
                
                // Validate that location was fetched (required)
                if (!fullAddress || !latitude || !longitude) {
                    setPlaceOrderLoading(false);
                    alert('Please fetch your location first by clicking "Fetch My Location" button');
                    return;
                }
                
                // Get manually entered barangay and purok (for delivery fee and rider info)
                const barangayInput = document.getElementById('barangay-input');
                const purokInput = document.getElementById('purok-input');
                
                if (!barangayInput || !purokInput) {
                    setPlaceOrderLoading(false);
                    alert('Please enter your barangay and purok');
                    return;
                }
                
                const enteredBarangay = barangayInput.value.trim();
                const enteredPurok = purokInput.value.trim();
                
                // Validate barangay and purok are entered
                if (!enteredBarangay || !enteredPurok) {
                    setPlaceOrderLoading(false);
                    alert('Please enter both barangay and purok');
                    return;
                }
                
                // Load allowed barangays if not loaded
                if (allowedBarangays.length === 0) {
                    await loadAllowedBarangays();
                }
                
                // Validate barangay is in allowed list (using normalized comparison for delivery fee)
                const matchingBarangay = findMatchingBarangay(enteredBarangay, allowedBarangays);
                if (!matchingBarangay) {
                    setPlaceOrderLoading(false);
                    alert(
                        `Delivery is not available to ${enteredBarangay}.\n\n` +
                        `We currently deliver to:\n${allowedBarangays.join(', ')}\n\n` +
                        `Please contact support if you believe this is an error.`
                    );
                    return;
                }

                // Token and customerId already obtained above

                // Build street address: purok + full fetched address
                // The full address is the exact location for the rider
                // Barangay and purok are additional info for the rider
                const streetAddress = `${enteredPurok}, ${fullAddress}`;

                // Create a temporary address for this order
                // Use fetched location (latitude/longitude) for rider navigation
                // Include barangay and purok in address for rider information
                let deliveryAddressId = null;
                try {
                    const addressData = {
                        label: 'Delivery Address',
                        streetAddress: streetAddress, // Purok + full address
                        city: enteredBarangay, // Barangay for additional info
                        zipCode: '0000',
                        apartment: null,
                        state: null,
                        latitude: parseFloat(latitude), // Required - for rider navigation
                        longitude: parseFloat(longitude), // Required - for rider navigation
                        isDefault: false
                    };

                    const addressResponse = await fetch(`${API_BASE_URL}/customers/${customerId}/addresses`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(addressData)
                    });

                    if (!addressResponse.ok) {
                        const errorData = await addressResponse.json().catch(() => ({ message: 'Failed to create address' }));
                        throw new Error(errorData.message || 'Failed to create delivery address');
                    }

                    const addressResult = await addressResponse.json();
                    deliveryAddressId = addressResult.data.id;
                    console.log('Temporary address created:', deliveryAddressId);
                } catch (addressError) {
                    console.error('Error creating address:', addressError);
                    setPlaceOrderLoading(false);
                    alert('Failed to create delivery address: ' + addressError.message);
                    return;
                }

                // Get cart data again to ensure we have the latest
                const cartResponse = await fetch(`${API_BASE_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!cartResponse.ok) {
                    throw new Error('Failed to load cart for order');
                }

                const cartData = await cartResponse.json();
                const cart = cartData.data || [];

                if (cart.length === 0) {
                    setPlaceOrderLoading(false);
                    alert('Your cart is empty');
                    window.location.href = 'shopping_cart.html';
                    return;
                }

                // Group items by restaurant
                const restaurants = {};
                cart.forEach(item => {
                    if (!restaurants[item.restaurantId]) {
                        restaurants[item.restaurantId] = {
                            id: item.restaurantId,
                            name: item.restaurantName || 'Restaurant',
                            items: []
                        };
                    }
                    restaurants[item.restaurantId].items.push(item);
                });

                const restaurantIds = Object.keys(restaurants);
                const closedRestaurants = [];

                // Check if all restaurants are open before placing order
                for (const restaurantId of restaurantIds) {
                    try {
                        const restaurantResponse = await fetch(`${API_BASE_URL}/restaurants/${restaurantId}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (restaurantResponse.ok) {
                            const restaurantData = await restaurantResponse.json();
                            const restaurant = restaurantData.data;
                            
                            if (!restaurant.isOpen) {
                                closedRestaurants.push({
                                    id: restaurantId,
                                    name: restaurant.name || cart.find(item => item.restaurantId === restaurantId)?.restaurantName || 'Restaurant'
                                });
                            }
                        }
                    } catch (error) {
                        console.error(`Error checking restaurant ${restaurantId}:`, error);
                    }
                }

                // If any restaurant is closed, prevent order placement
                if (closedRestaurants.length > 0) {
                    setPlaceOrderLoading(false);
                    const restaurantList = closedRestaurants.map(r => r.name).join(', ');
                    const isMultiple = closedRestaurants.length > 1;
                    const message = isMultiple
                        ? `The following restaurants in your cart are currently closed: ${restaurantList}. You cannot place an order when any restaurant is closed. Please remove items from closed restaurants or try again when they are open.`
                        : `${restaurantList} is currently closed. You cannot place an order when the restaurant is closed. Please try again when the restaurant is open.`;
                    
                    alert(message);
                    // Redirect back to cart
                    window.location.href = 'shopping_cart.html';
                    return;
                }

                // Create orders for each restaurant
                const orderResults = [];
                const failedOrders = [];

                for (const restaurantId of restaurantIds) {
                    const restaurant = restaurants[restaurantId];
                    
                    try {
                        // Convert cart items to order items format for this restaurant
                        const items = restaurant.items.map(item => ({
                            menuItemId: item.menuItemId,
                            variantId: item.variantId || null,
                            quantity: item.quantity,
                            specialInstructions: item.specialInstructions || null
                        }));

                        const orderData = {
                            customerId,
                            restaurantId,
                            deliveryAddressId: deliveryAddressId,
                            orderType: 'delivery',
                            tipAmount: 0,
                            items,
                            specialInstructions: null,
                            paymentMethod: 'gcash'
                        };

                        const response = await fetch(`${API_BASE_URL}/orders`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(orderData)
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ message: 'Failed to place order' }));
                            throw new Error(errorData.message || `Failed to place order for ${restaurant.name}`);
                        }

                        const result = await response.json();
                        const orderId = result.data.orderId;
                        const totalAmount = result.data.totalAmount;
                        
                        orderResults.push({
                            restaurantName: restaurant.name,
                            orderId: orderId,
                            totalAmount: totalAmount
                        });
                        console.log(`Order placed for ${restaurant.name}:`, result);
                    } catch (error) {
                        console.error(`Error placing order for ${restaurant.name}:`, error);
                        failedOrders.push({
                            restaurantName: restaurant.name,
                            error: error.message
                        });
                    }
                }

                // Check if all orders were successful
                if (failedOrders.length > 0) {
                    const failedNames = failedOrders.map(f => f.restaurantName).join(', ');
                    alert(`Some orders failed:\n${failedNames}\n\nSuccessful orders: ${orderResults.length}\nFailed orders: ${failedOrders.length}`);
                    
                    // If some orders succeeded, still clear cart and redirect
                    if (orderResults.length > 0) {
                        // Clear cart after successful orders
                        await fetch(`${API_BASE_URL}/cart`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        // Create PayMongo source and redirect to payment
                        await redirectToPaymongoPayment(orderResults[0].orderId, orderResults[0].totalAmount);
                    }
                    setPlaceOrderLoading(false);
                    return;
                }

                // All orders successful - clear cart
                await fetch(`${API_BASE_URL}/cart`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (orderResults.length > 1) {
                    alert(`Successfully placed ${orderResults.length} orders!\n\n${orderResults.map(r => `‚Ä¢ ${r.restaurantName}`).join('\n')}\n\nYou will be redirected to track your orders.`);
                    window.location.href = 'order_history.html';
                } else {
                    // Single order - create PayMongo source and redirect to payment
                    await redirectToPaymongoPayment(orderResults[0].orderId, orderResults[0].totalAmount);
                }

            } catch (error) {
                console.error('Error placing order:', error);
                setPlaceOrderLoading(false);
                alert('Failed to place order: ' + error.message);
            }
        }
    </script>
<script id="dhws-dataInjector" src="../../public/dhws-data-injector.js"></script>
</body>
</html>

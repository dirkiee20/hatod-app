<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Tracking - HATOD</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/pages.css">
  
  
  
  </head>
<body class="bg-background min-h-screen">
    <!-- Header Navigation -->
    <header class="bg-surface shadow-card border-b border-border">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <img src="../../public/logos/app_logo.png" alt="HATOD Logo" class="w-10 h-10 mr-3 object-contain">
                    <h1 class="text-xl font-bold text-text-primary">HATOD</h1>
                </div>

                <!-- Navigation -->
                <nav class="hidden md:flex space-x-8">
                    <a href="../restaurants/restaurant_browse.html" class="text-text-secondary hover:text-primary transition-smooth">Browse</a>
                    <a href="shopping_cart.html" class="text-text-secondary hover:text-primary transition-smooth">Cart</a>
                    <a href="order_tracking.html" class="text-primary font-medium border-b-2 border-primary pb-1">Orders</a>
                    <a href="customer_profile.html" class="text-text-secondary hover:text-primary transition-smooth">Account</a>
                </nav>

                <!-- User Profile & Back Button -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <img id="user-profile-img"
                             alt="Customer profile picture"
                             class="w-8 h-8 rounded-full object-cover"
                             onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit/crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                        <span id="user-name" class="text-sm font-medium text-text-primary hidden sm:block">Loading...</span>
                    </div>
                    <button onclick="history.back()" class="flex items-center space-x-2 text-text-secondary hover:text-primary transition-smooth">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                        <span class="text-sm font-medium">Back</span>
                    </button>
                </div>

            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-text-primary mb-2">Track Your Order</h2>
            <p class="text-text-secondary">Real-time updates on your order progress</p>
        </div>

                <!-- Current Order Status Card -->
        <section class="mb-8">
            <div class="bg-surface rounded-lg p-6 shadow-card border border-border">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-semibold text-text-primary mb-2">Order #<span id="order-id-display">Loading...</span></h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <img id="restaurant-logo-header" 
                                     alt="Restaurant logo" 
                                     class="w-8 h-8 rounded-full object-cover mr-2"
                                     onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                                <span id="restaurant-name-header" class="text-text-primary font-medium">Loading...</span>
                            </div>
                            <span class="text-text-secondary">•</span>
                            <span id="order-time-header" class="text-text-secondary">Loading...</span>
                        </div>
                    </div>
                    <div class="mt-4 lg:mt-0">
                        <div id="order-status-badge" class="bg-warning-100 text-warning-600 px-4 py-2 rounded-lg text-center">
                            <div class="font-semibold">Loading...</div>
                            <div class="text-sm">ETA: Calculating...</div>
                        </div>
                    </div>
                </div>

                <!-- Progress Timeline -->
                <div class="relative">
                    <!-- Desktop Timeline -->
                    <div class="hidden md:block">
                        <div class="flex items-center justify-between relative">
                            <!-- Progress Line -->
                            <div class="absolute top-6 left-0 w-full h-1 bg-gray-200 rounded-full">
                                <div class="h-full bg-primary rounded-full transition-all duration-1000 order-progress-bar"></div>
                            </div>
                            
                            <!-- Timeline Steps -->
                            <div class="flex justify-between w-full relative z-10">
                                <!-- Step 1: Order Placed -->
                                <div class="flex flex-col items-center">
                                    <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center mb-2">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-text-primary">Order Placed</div>
                                        <div class="text-xs text-text-secondary">2:45 PM</div>
                                    </div>
                                </div>

                                <!-- Step 2: Accepted -->
                                <div class="flex flex-col items-center">
                                    <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center mb-2">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-text-primary">Accepted</div>
                                        <div class="text-xs text-text-secondary">2:47 PM</div>
                                    </div>
                                </div>

                                <!-- Step 3: Preparing (Current) -->
                                <div class="flex flex-col items-center">
                                    <div class="w-12 h-12 bg-warning rounded-full flex items-center justify-center mb-2 status-pulse">
                                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-warning">Preparing</div>
                                        <div class="text-xs text-text-secondary">In progress</div>
                                    </div>
                                </div>

                                <!-- Step 4: Ready -->
                                <div class="flex flex-col items-center">
                                    <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mb-2">
                                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-text-secondary">Ready</div>
                                        <div class="text-xs text-text-secondary">Pending</div>
                                    </div>
                                </div>

                                <!-- Step 5: Out for Delivery -->
                                <div class="flex flex-col items-center">
                                    <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mb-2">
                                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                        </svg>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-text-secondary">Out for Delivery</div>
                                        <div class="text-xs text-text-secondary">Pending</div>
                                    </div>
                                </div>

                                <!-- Step 6: Delivered -->
                                <div class="flex flex-col items-center">
                                    <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mb-2">
                                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-text-secondary">Delivered</div>
                                        <div class="text-xs text-text-secondary">Pending</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile Timeline -->
                    <div class="md:hidden">
                        <div class="space-y-4">
                            <!-- Step 1: Order Placed -->
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-text-primary">Order Placed</div>
                                    <div class="text-xs text-text-secondary">2:45 PM - Order confirmed and sent to restaurant</div>
                                </div>
                            </div>

                            <!-- Step 2: Accepted -->
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-text-primary">Accepted by Restaurant</div>
                                    <div class="text-xs text-text-secondary">2:47 PM - Restaurant confirmed your order</div>
                                </div>
                            </div>

                            <!-- Step 3: Preparing (Current) -->
                            <div class="flex items-center space-x-4">
                                <div class="w-10 h-10 bg-warning rounded-full flex items-center justify-center flex-shrink-0 status-pulse">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-warning">Preparing Your Order</div>
                                    <div class="text-xs text-text-secondary">Kitchen is preparing your delicious meal</div>
                                </div>
                            </div>

                            <!-- Remaining steps (inactive) -->
                            <div class="flex items-center space-x-4 opacity-50">
                                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-text-secondary">Ready for Pickup</div>
                                    <div class="text-xs text-text-secondary">Order will be ready for delivery</div>
                                </div>
                            </div>

                            <div class="flex items-center space-x-4 opacity-50">
                                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-text-secondary">Out for Delivery</div>
                                    <div class="text-xs text-text-secondary">Driver is on the way to you</div>
                                </div>
                            </div>

                            <div class="flex items-center space-x-4 opacity-50">
                                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-medium text-text-secondary">Delivered</div>
                                    <div class="text-xs text-text-secondary">Enjoy your meal!</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Order Details and Actions -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Order Details -->
            <div class="lg:col-span-2">
                <div class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Order Details</h3>
                    
                    <!-- Order Items -->
                    <div class="space-y-4 mb-6">
                        <!-- Order items will be loaded here -->
                    </div>

                    <!-- Order Summary -->
                    <div class="space-y-2 pt-4 border-t border-border">
                        <div class="flex justify-between text-sm">
                            <span class="text-text-secondary">Subtotal</span>
                            <span class="text-text-primary">₱0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-text-secondary">Delivery Fee</span>
                            <span class="text-text-primary">₱0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-text-secondary">Tax</span>
                            <span class="text-text-primary">₱0.00</span>
                        </div>
                        <div class="flex justify-between font-semibold text-lg pt-2 border-t border-border">
                            <span class="text-text-primary">Total</span>
                            <span class="text-text-primary">₱0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Delivery Information & Actions -->
            <div class="space-y-6">
                <!-- Delivery Address -->
                <div class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Delivery Address</h3>
                    <div class="space-y-2">
                        <div class="font-medium text-text-primary">Customer</div>
                        <div class="text-text-secondary">
                            <!-- Address will be loaded here -->
                        </div>
                        <div class="text-text-secondary">
                            Phone: <!-- Phone will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Restaurant Contact -->
                <div class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Restaurant Contact</h3>
                    <div class="flex items-center space-x-3 mb-4">
                        <img src="https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" 
                             alt="Pizza Palace restaurant logo" 
                             class="w-12 h-12 rounded-full object-cover"
                             onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                        <div>
                            <div class="font-medium text-text-primary">Pizza Palace</div>
                            <div class="text-sm text-text-secondary">(555) 987-6543</div>
                        </div>
                    </div>
                    <button class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary-600 transition-smooth btn-hover">
                        <div class="flex items-center justify-center space-x-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            <span>Call Restaurant</span>
                        </div>
                    </button>
                </div>

                <!-- Quick Actions -->
                <div class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <button class="w-full bg-secondary text-white py-2 px-4 rounded-lg hover:bg-secondary-700 transition-smooth btn-hover">
                            <div class="flex items-center justify-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span>Get Help</span>
                            </div>
                        </button>
                        <button class="w-full border border-border text-text-primary py-2 px-4 rounded-lg hover:bg-gray-50 transition-smooth">
                            <div class="flex items-center justify-center space-x-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <span>View Receipt</span>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Updates Section -->
        <section class="mb-8">
            <div class="bg-surface rounded-lg p-6 shadow-card border border-border">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-text-primary">Live Updates</h3>
                    <div class="flex items-center space-x-2 text-success">
                        <div class="w-2 h-2 bg-success rounded-full status-pulse"></div>
                        <span class="text-sm font-medium">Live</span>
                    </div>
                </div>
                <div id="live-updates-container" class="space-y-3">
                    <!-- Live updates will be loaded here -->
                </div>
            </div>
        </section>

        <!-- Order History Link -->
        <section class="text-center">
            <div class="bg-surface rounded-lg p-6 shadow-card border border-border">
                <h3 class="text-lg font-semibold text-text-primary mb-2">Need to check another order?</h3>
                <p class="text-text-secondary mb-4">View all your past and current orders</p>
                <a href="order_history.html" class="inline-block bg-accent text-white px-6 py-2 rounded-lg hover:bg-accent-600 transition-smooth btn-hover">
                    View Order History
                </a>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-surface border-t border-border mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <p class="text-text-secondary text-sm">© 2025 HATOD. All Rights Reserved.</p>
                <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Privacy Policy</a>
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Terms of Service</a>
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Support</a>
                </div>
            </div>
        </div>
    </footer>
<script id="dhws-dataInjector" src="../../public/dhws-data-injector.js"></script>

<script>
    const API_BASE_URL = 'http://localhost:4000/api';

    document.addEventListener('DOMContentLoaded', () => {
        loadUserProfile();
        loadOrderTracking();
    });

    async function loadUserProfile() {
        try {
            const token = localStorage.getItem('authToken');
            if (!token) return;

            const payload = JSON.parse(atob(token.split('.')[1]));
            const userId = payload.sub;

            const response = await fetch(`${API_BASE_URL}/customers/${userId}/profile`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const result = await response.json();
                const profile = result.data;
                
                const userNameEl = document.getElementById('user-name');
                const userImgEl = document.getElementById('user-profile-img');
                
                if (userNameEl) {
                    userNameEl.textContent = profile.fullName || 'User';
                }
                if (userImgEl && profile.imageUrl) {
                    // Resolve image URL
                    const API_ORIGIN = API_BASE_URL.replace(/\/api$/, '');
                    const PLACEHOLDER_IMAGE = 'https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit/crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';
                    
                    let imageUrl = profile.imageUrl;
                    if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
                        const path = imageUrl.startsWith('/') ? imageUrl : `/${imageUrl}`;
                        imageUrl = `${API_ORIGIN}${path}`;
                    }
                    userImgEl.src = imageUrl || PLACEHOLDER_IMAGE;
                }
            }
        } catch (error) {
            console.error('Error loading user profile:', error);
        }
    }

    async function loadOrderTracking() {
        try {
            // Get order ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('orderId');

            if (!orderId) {
                // Silently redirect to order history if no orderId provided
                window.location.href = 'order_history.html';
                return;
            }

            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Please log in to track your order');
                window.location.href = '../login.html';
                return;
            }

            // Fetch order details and status history
            const orderResponse = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            let statusHistoryResponse = null;
            try {
                statusHistoryResponse = await fetch(`${API_BASE_URL}/orders/${orderId}/history`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
            } catch (e) {
                // Status history is optional
                console.log('Status history not available');
            }

            if (!orderResponse.ok) {
                throw new Error('Failed to load order details');
            }

            const result = await orderResponse.json();
            const { order, items, delivery } = result.data;

            let statusHistory = [];
            if (statusHistoryResponse && statusHistoryResponse.ok) {
                const historyResult = await statusHistoryResponse.json();
                statusHistory = historyResult.data || [];
            }

            // Update the page with real data
            await updateOrderTracking(order, items, delivery, statusHistory);

        } catch (error) {
            console.error('Error loading order tracking:', error);
            alert('Failed to load order details. Please try again.');
        }
    }

    async function updateOrderTracking(order, items, delivery, statusHistory) {
        // Update order ID
        const orderIdElement = document.getElementById('order-id-display');
        if (orderIdElement) {
            orderIdElement.textContent = order.id.slice(-8).toUpperCase();
        }

        // Update restaurant info in header
        const restaurantLogo = document.getElementById('restaurant-logo-header');
        const restaurantName = document.getElementById('restaurant-name-header');
        const orderTimeHeader = document.getElementById('order-time-header');

        if (restaurantLogo) restaurantLogo.src = order.restaurantImageUrl || restaurantLogo.src;
        if (restaurantLogo) restaurantLogo.alt = `${order.restaurantName || 'Restaurant'} logo`;
        if (restaurantName) restaurantName.textContent = order.restaurantName || 'Restaurant';
        if (orderTimeHeader) {
            const orderDate = new Date(order.createdAt);
            const timeStr = orderDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            orderTimeHeader.textContent = `Placed at ${timeStr}`;
        }

        // Update status badge
        const statusElement = document.getElementById('order-status-badge');
        const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1).replace('_', ' ');
        const statusColors = {
            'pending': 'bg-yellow-100 text-yellow-600',
            'confirmed': 'bg-blue-100 text-blue-600',
            'preparing': 'bg-warning-100 text-warning-600',
            'ready': 'bg-purple-100 text-purple-600',
            'picked_up': 'bg-indigo-100 text-indigo-600',
            'delivered': 'bg-green-100 text-green-600',
            'cancelled': 'bg-red-100 text-red-600'
        };
        const statusColor = statusColors[order.status] || 'bg-gray-100 text-gray-600';
        
        if (statusElement) {
            statusElement.className = `${statusColor} px-4 py-2 rounded-lg text-center`;
            const etaText = order.estimatedDeliveryTime 
                ? `ETA: ${order.estimatedDeliveryTime} minutes`
                : 'ETA: Calculating...';
            statusElement.innerHTML = `
                <div class="font-semibold">${statusText}</div>
                <div class="text-sm">${etaText}</div>
            `;
        }

        // Update progress bar and timeline based on status
        updateProgressTimeline(order.status, order.createdAt);

        // Update order items
        const orderItemsContainer = document.querySelector('.space-y-4.mb-6');
        let itemsHtml = '';

        if (items && items.length > 0) {
            items.forEach(item => {
                const itemTotal = (parseFloat(item.unitPrice) || 0) * (parseInt(item.quantity) || 1);
                itemsHtml += `
                    <div class="flex items-center justify-between py-3 border-b border-border">
                        <div class="flex items-center space-x-3">
                            <img src="${item.imageUrl || 'https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'}"
                                 alt="${item.menuItemName || 'Menu item'}"
                                 class="w-12 h-12 rounded-lg object-cover"
                                 onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                            <div>
                                <div class="font-medium text-text-primary">${item.menuItemName || 'Menu item'}</div>
                                <div class="text-sm text-text-secondary">Quantity: ${item.quantity || 1}${item.specialInstructions ? ' • ' + item.specialInstructions : ''}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium text-text-primary">₱${itemTotal.toFixed(2)}</div>
                            <div class="text-sm text-text-secondary">₱${(parseFloat(item.unitPrice) || 0).toFixed(2)} each</div>
                        </div>
                    </div>
                `;
            });
        } else {
            itemsHtml = '<div class="text-text-secondary text-center py-4">No items found</div>';
        }

        if (orderItemsContainer) orderItemsContainer.innerHTML = itemsHtml;

        // Update order summary
        const subtotalElement = document.querySelector('.space-y-2.pt-4.border-t.border-border .flex.justify-between.text-sm:nth-child(1) span:last-child');
        const deliveryFeeElement = document.querySelector('.space-y-2.pt-4.border-t.border-border .flex.justify-between.text-sm:nth-child(2) span:last-child');
        const taxElement = document.querySelector('.space-y-2.pt-4.border-t.border-border .flex.justify-between.text-sm:nth-child(3) span:last-child');
        const totalElement = document.querySelector('.flex.justify-between.font-semibold.text-lg.pt-2.border-t.border-border span:last-child');

        if (subtotalElement) subtotalElement.textContent = `₱${(parseFloat(order.subtotal) || 0).toFixed(2)}`;
        if (deliveryFeeElement) deliveryFeeElement.textContent = `₱${(parseFloat(order.deliveryFee) || 0).toFixed(2)}`;
        if (taxElement) taxElement.textContent = `₱0.00`;
        if (totalElement) totalElement.textContent = `₱${(parseFloat(order.totalAmount) || 0).toFixed(2)}`;

        // Update delivery address and restaurant contact
        await updateDeliveryAddress(order);
        await updateRestaurantContact(order, delivery);
        
        // Update live updates from status history
        updateLiveUpdates(statusHistory, order);
    }

    async function updateDeliveryAddress(order) {
        try {
            const token = localStorage.getItem('authToken');
            if (!token || !order.deliveryAddressId) {
                // Use delivery address from order if available
                if (order.deliveryAddress) {
                    const addressContainer = document.querySelector('.bg-surface.rounded-lg.p-6.shadow-card.border.border-border .space-y-2');
                    if (addressContainer) {
                        const addressElement = addressContainer.querySelector('.text-text-secondary');
                        if (addressElement) {
                            addressElement.innerHTML = `
                                <span class="font-medium text-text-primary">Address:</span><br>
                                ${order.deliveryAddress}
                            `;
                        }
                    }
                }
                return;
            }

            // Fetch address details
            const response = await fetch(`${API_BASE_URL}/customers/${order.customerId}/addresses/${order.deliveryAddressId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const addressData = await response.json();
                const address = addressData.data;

                const addressContainer = document.querySelector('.bg-surface.rounded-lg.p-6.shadow-card.border.border-border .space-y-2');
                if (addressContainer) {
                    const nameElement = addressContainer.querySelector('.font-medium.text-text-primary');
                    const addressElement = addressContainer.querySelector('.text-text-secondary');
                    const phoneElement = addressContainer.querySelector('.text-text-secondary:last-child');

                    if (nameElement) nameElement.textContent = order.customerName || 'Customer';
                    if (addressElement) {
                        addressElement.innerHTML = `
                            ${address.streetAddress || ''}${address.apartment ? ', ' + address.apartment : ''}<br>
                            ${address.city || ''}${address.state ? ', ' + address.state : ''} ${address.zipCode || ''}<br>
                            ${address.country || 'Philippines'}
                        `;
                    }
                    if (phoneElement && order.customerPhone) {
                        phoneElement.textContent = `Phone: ${order.customerPhone}`;
                    } else if (phoneElement) {
                        phoneElement.textContent = '';
                    }
                }
            } else if (order.deliveryAddress) {
                // Fallback to order delivery address
                const addressContainer = document.querySelector('.bg-surface.rounded-lg.p-6.shadow-card.border.border-border .space-y-2');
                if (addressContainer) {
                    const addressElement = addressContainer.querySelector('.text-text-secondary');
                    if (addressElement) {
                        addressElement.innerHTML = `
                            ${order.deliveryAddress}
                        `;
                    }
                }
            }
        } catch (error) {
            console.error('Error loading delivery address:', error);
            // Fallback to order delivery address
            if (order.deliveryAddress) {
                const addressContainer = document.querySelector('.bg-surface.rounded-lg.p-6.shadow-card.border.border-border .space-y-2');
                if (addressContainer) {
                    const addressElement = addressContainer.querySelector('.text-text-secondary');
                    if (addressElement) {
                        addressElement.innerHTML = `${order.deliveryAddress}`;
                    }
                }
            }
        }
    }

    async function updateRestaurantContact(order, delivery) {
        try {
            const token = localStorage.getItem('authToken');
            
            // Use order data first (already fetched)
            const contactContainer = document.querySelector('.bg-surface.rounded-lg.p-6.shadow-card.border.border-border .flex.items-center.space-x-3.mb-4');
            if (contactContainer) {
                const logoElement = contactContainer.querySelector('img');
                const nameElement = contactContainer.querySelector('.font-medium.text-text-primary');
                const phoneElement = contactContainer.querySelector('.text-sm.text-text-secondary');

                if (logoElement) logoElement.src = order.restaurantImageUrl || logoElement.src;
                if (logoElement) logoElement.alt = `${order.restaurantName || 'Restaurant'} logo`;
                if (nameElement) nameElement.textContent = order.restaurantName || 'Restaurant';
                if (phoneElement) phoneElement.textContent = order.restaurantPhone || 'Phone not available';
            }

            // Update call button
            const callButton = document.querySelector('button:has(svg:has(path[d*="M3 5a2"]))');
            if (callButton && order.restaurantPhone) {
                callButton.onclick = () => {
                    window.location.href = `tel:${order.restaurantPhone}`;
                };
            }
        } catch (error) {
            console.error('Error loading restaurant contact:', error);
        }
    }

    function updateLiveUpdates(statusHistory, order) {
        const updatesContainer = document.getElementById('live-updates-container');
        if (!updatesContainer) return;

        if (!statusHistory || statusHistory.length === 0) {
            // Create default updates from order status
            const defaultUpdates = [
                {
                    status: order.status,
                    note: `Order is ${order.status.replace('_', ' ')}`,
                    createdAt: order.createdAt
                }
            ];
            statusHistory = defaultUpdates;
        }

        // Sort by date (newest first)
        const sortedHistory = [...statusHistory].sort((a, b) => 
            new Date(b.createdAt) - new Date(a.createdAt)
        );

        let updatesHtml = '';
        const statusMessages = {
            'pending': 'Order placed successfully',
            'confirmed': 'Order accepted by restaurant',
            'preparing': 'Order is being prepared',
            'ready': 'Order is ready for pickup',
            'picked_up': 'Order is out for delivery',
            'delivered': 'Order has been delivered',
            'cancelled': 'Order has been cancelled'
        };

        const statusColors = {
            'pending': 'bg-primary',
            'confirmed': 'bg-primary',
            'preparing': 'bg-warning',
            'ready': 'bg-purple-500',
            'picked_up': 'bg-indigo-500',
            'delivered': 'bg-green-500',
            'cancelled': 'bg-red-500'
        };

        sortedHistory.forEach(event => {
            const status = event.status || order.status;
            const message = statusMessages[status] || `Order status: ${status}`;
            const note = event.note || '';
            const color = statusColors[status] || 'bg-gray-500';
            const date = new Date(event.createdAt || order.createdAt);
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            updatesHtml += `
                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                    <div class="w-2 h-2 ${color} rounded-full mt-2 flex-shrink-0"></div>
                    <div>
                        <div class="text-sm font-medium text-text-primary">${message}</div>
                        <div class="text-xs text-text-secondary">${timeStr} ${dateStr}${note ? ' - ' + note : ''}</div>
                    </div>
                </div>
            `;
        });

        updatesContainer.innerHTML = updatesHtml || '<div class="text-text-secondary text-center py-4">No updates available</div>';
    }

    function updateProgressTimeline(status, createdAt) {
        const statusOrder = ['pending', 'confirmed', 'preparing', 'ready', 'picked_up', 'delivered'];
        const currentIndex = statusOrder.indexOf(status);
        
        // Calculate time differences for timeline
        const orderDate = new Date(createdAt);
        const now = new Date();
        const timeDiff = Math.floor((now - orderDate) / 1000 / 60); // minutes

        // Update progress bar width
        const progressBar = document.querySelector('.order-progress-bar');
        if (progressBar) {
            const progress = ((currentIndex + 1) / statusOrder.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        // Update step icons and colors (desktop)
        const steps = document.querySelectorAll('.hidden.md\\:block .flex.justify-between.w-full.relative.z-10 .flex.flex-col.items-center');
        const stepLabels = ['Order Placed', 'Accepted', 'Preparing', 'Ready', 'Out for Delivery', 'Delivered'];
        const stepStatuses = ['pending', 'confirmed', 'preparing', 'ready', 'picked_up', 'delivered'];
        
        steps.forEach((step, index) => {
            const icon = step.querySelector('div.w-12.h-12');
            const text = step.querySelector('div.text-sm.font-medium');
            const timeText = step.querySelector('div.text-xs.text-text-secondary');

            if (icon) {
                if (index <= currentIndex) {
                    // Completed or current step
                    if (index === currentIndex) {
                        // Current step - use warning color and pulse
                        icon.className = 'w-12 h-12 bg-warning rounded-full flex items-center justify-center mb-2 status-pulse';
                        if (text) {
                            text.className = 'text-sm font-medium text-warning';
                            text.textContent = stepLabels[index];
                        }
                        if (timeText) timeText.textContent = 'In progress';
                    } else {
                        // Completed step
                        icon.className = 'w-12 h-12 bg-primary rounded-full flex items-center justify-center mb-2';
                        if (text) {
                            text.className = 'text-sm font-medium text-text-primary';
                            text.textContent = stepLabels[index];
                        }
                        if (timeText) {
                            const stepTime = new Date(createdAt);
                            stepTime.setMinutes(stepTime.getMinutes() + (index * 2)); // Estimate
                            timeText.textContent = stepTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                        }
                    }
                } else {
                    // Future steps
                    icon.className = 'w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center mb-2';
                    if (text) {
                        text.className = 'text-sm font-medium text-text-secondary';
                        text.textContent = stepLabels[index];
                    }
                    if (timeText) timeText.textContent = 'Pending';
                }
            }
        });

        // Update mobile timeline
        const mobileSteps = document.querySelectorAll('.md\\:hidden .flex.items-center.space-x-4');
        mobileSteps.forEach((step, index) => {
            const icon = step.querySelector('div.w-10.h-10');
            const text = step.querySelector('div.text-sm.font-medium');

            if (icon) {
                if (index <= currentIndex) {
                    icon.className = 'w-10 h-10 bg-primary rounded-full flex items-center justify-center flex-shrink-0';
                    if (text) text.className = 'text-sm font-medium text-text-primary';
                } else {
                    icon.className = 'w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0';
                    if (text) text.className = 'text-sm font-medium text-text-secondary';
                }
            }
        });
    }
</script>
</body>
</html>

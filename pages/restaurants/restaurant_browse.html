<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Restaurants - HATOD</title>
    <link rel="stylesheet" href="../../css/main.css">

  
  
  </head>
<body class="bg-background min-h-screen">
    <!-- Header Navigation -->
    <header class="bg-surface shadow-card border-b border-border">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="../restaurants/restaurant_browse.html" class="flex items-center">
                        <img src="../../public/logos/app_logo.png" alt="HATOD Logo" class="w-10 h-10 mr-3 object-contain">
                        <h1 class="text-xl font-bold text-text-primary">HATOD</h1>
                    </a>
                </div>

                <!-- Search Bar -->
                <div class="hidden md:flex flex-1 max-w-lg mx-8">
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                        <input type="text"
                               placeholder="Search restaurants or cuisines..."
                               class="block w-full pl-10 pr-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="restaurant_browse.html" class="text-primary font-medium border-b-2 border-primary pb-1">Browse</a>
                    <a href="../customers/shopping_cart.html" class="text-text-secondary hover:text-primary transition-smooth">Cart</a>
                    <a href="../customers/order_history.html" class="text-text-secondary hover:text-primary transition-smooth">Orders</a>
                    <a href="../customers/customer_profile.html" class="text-text-secondary hover:text-primary transition-smooth">Account</a>
                </nav>

                <!-- Cart Icon & User Profile -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <img id="user-profile-img"
                             alt="Customer profile picture"
                             class="w-8 h-8 rounded-full object-cover"
                             onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit/crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                    </div>
                </div>

            </div>
        </div>

        <!-- Mobile Search Bar -->
        <div class="md:hidden px-4 pb-4">
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="w-5 h-5 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                <input type="text"
                       placeholder="Search restaurants or cuisines..."
                       class="block w-full pl-10 pr-3 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Location & Results Header -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
            <div class="flex items-center space-x-2 mb-4 sm:mb-0">
                <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span class="text-text-primary font-medium">Your Location</span>
                <button class="text-primary text-sm hover:text-primary-600 transition-smooth">Change</button>
            </div>
            <div class="text-text-secondary text-sm">
                <span class="font-medium text-text-primary">0</span> restaurants available
            </div>
        </div>

        <!-- Filters Section -->
        <section class="mb-6">
            <!-- Desktop Filters -->
            <div class="hidden lg:block">
                <div class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <div class="flex flex-wrap items-center gap-6">
                        <!-- Cuisine Type Chips -->
                        <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium text-text-primary">Cuisine:</span>
                            <div class="flex flex-wrap gap-2">
                                <button class="px-3 py-1 text-sm bg-primary text-white rounded-full hover:bg-primary-600 transition-smooth">All</button>
                                <button class="px-3 py-1 text-sm bg-gray-100 text-text-secondary rounded-full hover:bg-primary hover:text-white transition-smooth">Italian</button>
                                <button class="px-3 py-1 text-sm bg-gray-100 text-text-secondary rounded-full hover:bg-primary hover:text-white transition-smooth">Asian</button>
                                <button class="px-3 py-1 text-sm bg-gray-100 text-text-secondary rounded-full hover:bg-primary hover:text-white transition-smooth">Mexican</button>
                                <button class="px-3 py-1 text-sm bg-gray-100 text-text-secondary rounded-full hover:bg-primary hover:text-white transition-smooth">American</button>
                                <button class="px-3 py-1 text-sm bg-gray-100 text-text-secondary rounded-full hover:bg-primary hover:text-white transition-smooth">Indian</button>
                            </div>
                        </div>

                        <!-- Delivery Time Filter -->
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-medium text-text-primary">Delivery:</span>
                            <select class="border border-border rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option>Any time</option>
                                <option>Under 30 min</option>
                                <option>Under 45 min</option>
                                <option>Under 60 min</option>
                            </select>
                        </div>

                        <!-- Rating Filter -->
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-medium text-text-primary">Rating:</span>
                            <select class="border border-border rounded-lg px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option>Any rating</option>
                                <option>4.5+ stars</option>
                                <option>4.0+ stars</option>
                                <option>3.5+ stars</option>
                            </select>
                        </div>

                        <!-- Price Range -->
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-medium text-text-primary">Price:</span>
                            <div class="flex space-x-1">
                                <button class="px-2 py-1 text-sm bg-primary text-white rounded hover:bg-primary-600 transition-smooth">₱</button>
                                <button class="px-2 py-1 text-sm bg-gray-100 text-text-secondary rounded hover:bg-primary hover:text-white transition-smooth">₱₱</button>
                                <button class="px-2 py-1 text-sm bg-gray-100 text-text-secondary rounded hover:bg-primary hover:text-white transition-smooth">₱₱₱</button>
                                <button class="px-2 py-1 text-sm bg-gray-100 text-text-secondary rounded hover:bg-primary hover:text-white transition-smooth">₱₱₱₱</button>
                            </div>
                        </div>

                        <!-- Clear Filters -->
                        <button class="text-primary text-sm hover:text-primary-600 transition-smooth flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <span>Clear all</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Mobile Filter Button -->
            <div class="lg:hidden flex items-center justify-between mb-4">
                <button class="flex items-center space-x-2 bg-surface border border-border rounded-lg px-4 py-2 shadow-card">
                    <svg class="w-5 h-5 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.414A1 1 0 013 6.707V4z"/>
                    </svg>
                    <span class="text-sm font-medium text-text-primary">Filters</span>
                    <span class="bg-primary text-white text-xs px-2 py-1 rounded-full">0</span>
                </button>

                <!-- Sort Dropdown -->
                <select class="border border-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <option>Sort by Relevance</option>
                    <option>Highest Rated</option>
                    <option>Fastest Delivery</option>
                    <option>Distance</option>
                    <option>Price: Low to High</option>
                </select>
            </div>

            <!-- Desktop Sort Options -->
            <div class="hidden lg:flex items-center justify-between mt-4">
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium text-text-primary">Sort by:</span>
                    <button class="text-sm text-primary font-medium border-b-2 border-primary pb-1">Relevance</button>
                    <button class="text-sm text-text-secondary hover:text-primary transition-smooth">Highest Rated</button>
                    <button class="text-sm text-text-secondary hover:text-primary transition-smooth">Fastest Delivery</button>
                    <button class="text-sm text-text-secondary hover:text-primary transition-smooth">Distance</button>
                </div>
            </div>
        </section>

        <!-- Restaurant Grid -->
        <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Empty State -->
            <div class="col-span-full bg-surface rounded-lg p-12 shadow-card border border-border text-center">
                <svg class="w-16 h-16 text-text-secondary mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                <h3 class="text-lg font-semibold text-text-primary mb-2">No restaurants available</h3>
                <p class="text-text-secondary mb-6">Restaurants will appear here once they are added to the platform.</p>
                <button class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-600 transition-smooth btn-hover">
                    Check Back Later
                </button>
            </div>
        </section>

        <!-- Load More Section -->
        <section class="mt-12 text-center">
            <button class="bg-surface border border-border text-text-primary px-8 py-3 rounded-lg hover:bg-gray-50 transition-smooth shadow-card">
                Load More Restaurants
            </button>
            <p class="text-text-secondary text-sm mt-4">Showing 0 of 0 restaurants</p>
        </section>
    </main>

    <!-- Mobile Bottom Tab Navigation -->
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-surface border-t border-border shadow-lg z-50">
        <div class="flex items-center justify-around py-2 px-4">
            <a href="restaurant_browse.html" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors active-tab">
                <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <span class="text-xs font-medium text-primary">Browse</span>
            </a>
            <a href="../customers/shopping_cart.html" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors relative">
                <div class="relative">
                    <svg class="w-6 h-6 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9M17 21a2 2 0 100-4 2 2 0 000 4zM9 21a2 2 0 100-4 2 2 0 000 4z"/>
                    </svg>
                    <span class="absolute -top-1 -right-1 bg-primary text-white text-xs rounded-full w-5 h-5 flex items-center justify-center text-[10px]">0</span>
                </div>
                <span class="text-xs font-medium text-text-secondary">Cart</span>
            </a>
            <a href="../customers/order_history.html" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors">
                <svg class="w-6 h-6 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <span class="text-xs font-medium text-text-secondary">Orders</span>
            </a>
            <a href="../customers/customer_profile.html" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors">
                <svg class="w-6 h-6 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span class="text-xs font-medium text-text-secondary">Account</span>
            </a>
        </div>
    </nav>

    <!-- Footer -->
    <footer class="bg-surface border-t border-border mt-12 pb-20 lg:pb-0">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <p class="text-text-secondary text-sm">© 2025 HATOD. All Rights Reserved.</p>
                <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Privacy Policy</a>
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Terms of Service</a>
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Support</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="../../public/config.js"></script>
    <script>
        // API base URL (from config.js - automatically uses Railway URL in mobile apps)
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = window.API_BASE_URL || 'http://localhost:4000/api';

            // Elements
            const restaurantGrid = document.querySelector('section.grid');
            const resultsCount = document.querySelector('span.font-medium.text-text-primary');
            const loadMoreBtn = document.querySelector('button.bg-surface.border');
            const loadMoreText = document.querySelector('p.text-text-secondary.text-sm.mt-4');

            let currentPage = 1;
            let isLoading = false;
            let hasMore = true;

            function showLoading() {
                const loadingCard = document.createElement('div');
                loadingCard.className = 'col-span-full bg-surface rounded-lg p-12 shadow-card border border-border text-center';
                loadingCard.innerHTML = `
                    <div class="flex items-center justify-center">
                        <svg class="w-8 h-8 animate-spin text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                        </svg>
                    </div>
                    <p class="text-text-secondary mt-4">Loading restaurants...</p>
                `;
                restaurantGrid.innerHTML = '';
                restaurantGrid.appendChild(loadingCard);
            }

            function renderRestaurantCard(restaurant) {
                const card = document.createElement('div');
                const isOpen = restaurant.isOpen !== false; // Default to true if not set
                card.className = `bg-surface rounded-lg shadow-card border border-border overflow-hidden hover:shadow-md transition-smooth ${!isOpen ? 'opacity-75' : ''}`;

                const imageUrl = restaurant.bannerUrl || restaurant.imageUrl || 'https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit/crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';
                const deliveryFee = parseFloat(restaurant.deliveryFee || 0).toFixed(2);

                card.innerHTML = `
                    <div class="aspect-w-16 aspect-h-12 bg-gray-200 relative">
                        <img src="${imageUrl}"
                             alt="${restaurant.name}"
                             class="w-full h-48 object-cover ${!isOpen ? 'grayscale' : ''}"
                             onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit/crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                        ${!isOpen ? `
                        <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20">
                            <span class="bg-error text-white px-4 py-2 rounded-lg font-semibold text-sm">CLOSED</span>
                        </div>
                        ` : ''}
                        <!-- Favorite Button -->
                        <button class="favorite-btn absolute top-3 right-3 p-2 bg-white rounded-full shadow-card hover:bg-gray-50 transition-smooth z-10"
                                data-restaurant-id="${restaurant.id}"
                                onclick="toggleFavorite(this, '${restaurant.id}')"
                                title="Add to favorites">
                            <svg class="w-5 h-5 text-text-secondary favorite-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <h3 class="font-semibold text-text-primary text-lg">${restaurant.name}</h3>
                                <p class="text-sm text-text-secondary">${restaurant.cuisineType || 'Restaurant'}</p>
                            </div>
                            <div class="flex items-center space-x-1">
                                <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                                <span class="text-sm text-text-secondary">${restaurant.rating || 'N/A'}</span>
                            </div>
                        </div>

                        <div class="flex items-center justify-between text-sm mb-3">
                            <div class="flex items-center space-x-2">
                                <span class="text-text-secondary">${restaurant.deliveryTimeMinutes || 30} min</span>
                                <span class="text-text-secondary">•</span>
                                <span class="text-text-secondary">₱${deliveryFee} delivery</span>
                            </div>
                            <div class="flex items-center space-x-1">
                                <div class="w-2 h-2 rounded-full ${isOpen ? 'bg-success' : 'bg-error'}"></div>
                                <span class="text-xs font-medium ${isOpen ? 'text-success' : 'text-error'}">${isOpen ? 'Open' : 'Closed'}</span>
                            </div>
                        </div>

                        <button class="w-full ${isOpen ? 'bg-primary text-white hover:bg-primary-600' : 'bg-gray-300 text-gray-500 cursor-not-allowed'} py-2 px-4 rounded-lg transition-smooth text-sm font-medium"
                                ${isOpen ? `onclick="window.location.href='restaurant_menu.html?id=${restaurant.id}'"` : 'disabled'}
                                ${!isOpen ? 'title="Restaurant is currently closed"' : ''}>
                            ${isOpen ? 'View Menu' : 'Closed'}
                        </button>
                    </div>
                `;

                return card;
            }

            function showEmptyState() {
                restaurantGrid.innerHTML = `
                    <div class="col-span-full bg-surface rounded-lg p-12 shadow-card border border-border text-center">
                        <svg class="w-16 h-16 text-text-secondary mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        <h3 class="text-lg font-semibold text-text-primary mb-2">No restaurants available</h3>
                        <p class="text-text-secondary mb-6">Restaurants will appear here once they are added to the platform.</p>
                        <button class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-600 transition-smooth btn-hover">
                            Check Back Later
                        </button>
                    </div>
                `;
            }

            async function fetchRestaurants(page = 1, append = false) {
                if (isLoading) return;

                isLoading = true;

                try {
                    const headers = {
                        'Accept': 'application/json'
                    };

                    // Add auth token if available
                    const authToken = localStorage.getItem('authToken');
                    if (authToken) {
                        headers.Authorization = `Bearer ${authToken}`;
                    }

                    const response = await fetch(`${API_BASE_URL}/restaurants?page=${page}&pageSize=12`, {
                        headers
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to load restaurants (${response.status})`);
                    }

                    const data = await response.json();
                    const restaurants = data.data || [];
                    const meta = data.meta || {};

                    if (!append) {
                        restaurantGrid.innerHTML = '';
                    }

                    if (restaurants.length === 0 && !append) {
                        showEmptyState();
                        resultsCount.textContent = '0';
                        loadMoreText.textContent = 'Showing 0 of 0 restaurants';
                        loadMoreBtn.style.display = 'none';
                        return;
                    }

                    restaurants.forEach(restaurant => {
                        const card = renderRestaurantCard(restaurant);
                        restaurantGrid.appendChild(card);
                    });

                    // Update favorite buttons after rendering
                    updateFavoriteButtons();

                    // Update results count
                    resultsCount.textContent = meta.total || restaurants.length;

                    // Update load more section
                    const total = meta.total || 0;
                    const showing = Math.min(page * 12, total);
                    loadMoreText.textContent = `Showing ${showing} of ${total} restaurants`;

                    // Check if there are more pages
                    hasMore = page < (meta.totalPages || 1);
                    loadMoreBtn.style.display = hasMore ? 'block' : 'none';

                } catch (error) {
                    console.error('Error loading restaurants:', error);
                    if (!append) {
                        restaurantGrid.innerHTML = `
                            <div class="col-span-full bg-surface rounded-lg p-12 shadow-card border border-border text-center">
                                <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <h3 class="text-lg font-semibold text-text-primary mb-2">Failed to load restaurants</h3>
                                <p class="text-text-secondary mb-6">Please try again later.</p>
                                <button class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-600 transition-smooth btn-hover" onclick="fetchRestaurants(1, false)">
                                    Try Again
                                </button>
                            </div>
                        `;
                    }
                } finally {
                    isLoading = false;
                }
            }

            // Load more button click
            loadMoreBtn.addEventListener('click', () => {
                if (!isLoading && hasMore) {
                    currentPage++;
                    fetchRestaurants(currentPage, true);
                }
            });

            // Store favorite restaurants
            let favoriteRestaurants = new Set();

            // Initial load
            showLoading();
            fetchRestaurants(1, false);
            loadUserProfile();
            loadFavorites();

            async function loadFavorites() {
                try {
                    const token = localStorage.getItem('authToken');
                    if (!token) return;

                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const userId = payload.sub;

                    const response = await fetch(`${API_BASE_URL}/customers/${userId}/favorites`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        favoriteRestaurants = new Set(result.data.map(fav => fav.restaurantId));
                        updateFavoriteButtons();
                    }
                } catch (error) {
                    console.error('Error loading favorites:', error);
                }
            }

            function updateFavoriteButtons() {
                document.querySelectorAll('.favorite-btn').forEach(btn => {
                    const restaurantId = btn.getAttribute('data-restaurant-id');
                    const icon = btn.querySelector('.favorite-icon');
                    
                    if (favoriteRestaurants.has(restaurantId)) {
                        icon.classList.remove('text-text-secondary');
                        icon.classList.add('text-primary', 'fill-current');
                        btn.setAttribute('title', 'Remove from favorites');
                    } else {
                        icon.classList.remove('text-primary', 'fill-current');
                        icon.classList.add('text-text-secondary');
                        btn.setAttribute('title', 'Add to favorites');
                    }
                });
            }

            window.toggleFavorite = async function(button, restaurantId) {
                try {
                    const token = localStorage.getItem('authToken');
                    if (!token) {
                        alert('Please log in to favorite restaurants');
                        window.location.href = '../login.html';
                        return;
                    }

                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const customerId = payload.sub;

                    const response = await fetch(`${API_BASE_URL}/customers/${customerId}/favorites`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ restaurantId })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to toggle favorite');
                    }

                    const result = await response.json();
                    const isFavorite = result.data.isFavorite;

                    // Update local state
                    if (isFavorite) {
                        favoriteRestaurants.add(restaurantId);
                    } else {
                        favoriteRestaurants.delete(restaurantId);
                    }

                    // Update UI
                    const icon = button.querySelector('.favorite-icon');
                    if (isFavorite) {
                        icon.classList.remove('text-text-secondary');
                        icon.classList.add('text-primary', 'fill-current');
                        button.setAttribute('title', 'Remove from favorites');
                    } else {
                        icon.classList.remove('text-primary', 'fill-current');
                        icon.classList.add('text-text-secondary');
                        button.setAttribute('title', 'Add to favorites');
                    }

                    // Fetch updated restaurant data to get the new rating
                    try {
                        const restaurantResponse = await fetch(`${API_BASE_URL}/restaurants/${restaurantId}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (restaurantResponse.ok) {
                            const restaurantData = await restaurantResponse.json();
                            const updatedRestaurant = restaurantData.data;
                            
                            // Find the card and update the rating display
                            const card = button.closest('.bg-surface.rounded-lg');
                            if (card) {
                                // Find the rating element - it's in a div with flex items-center space-x-1
                                const ratingContainer = card.querySelector('.flex.items-center.space-x-1');
                                if (ratingContainer) {
                                    const ratingElement = ratingContainer.querySelector('span.text-sm.text-text-secondary');
                                    if (ratingElement) {
                                        ratingElement.textContent = updatedRestaurant.rating ? updatedRestaurant.rating.toFixed(1) : 'N/A';
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching updated restaurant rating:', error);
                        // Don't show error to user, just log it
                    }
                } catch (error) {
                    console.error('Error toggling favorite:', error);
                    alert('Failed to update favorite. Please try again.');
                }
            };

            async function loadUserProfile() {
                try {
                    const token = localStorage.getItem('authToken');
                    if (!token) return;

                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const userId = payload.sub;

                    const response = await fetch(`${API_BASE_URL}/customers/${userId}/profile`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const profile = result.data;
                        
                        const userImgEl = document.getElementById('user-profile-img');
                        
                        if (userImgEl && profile.imageUrl) {
                            // Resolve image URL
                            const API_ORIGIN = API_BASE_URL.replace(/\/api$/, '');
                            const PLACEHOLDER_IMAGE = 'https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';
                            
                            let imageUrl = profile.imageUrl;
                            if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
                                const path = imageUrl.startsWith('/') ? imageUrl : `/${imageUrl}`;
                                imageUrl = `${API_ORIGIN}${path}`;
                            }
                            userImgEl.src = imageUrl || PLACEHOLDER_IMAGE;
                        }
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            }
        });
    </script>

    <script id="dhws-dataInjector" src="../../public/dhws-data-injector.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - HATOD</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/pages.css">
  
  
  
  </head>
<body class="bg-background min-h-screen">
    <!-- Header Navigation -->
    <header class="bg-surface shadow-card border-b border-border">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <a href="../restaurants/restaurant_browse.html" class="flex items-center">
                        <img src="../../public/logos/app_logo.png" alt="HATOD Logo" class="w-10 h-10 mr-3 object-contain">
                        <h1 class="text-xl font-bold text-text-primary">HATOD</h1>
                    </a>
                </div>

                <!-- Navigation -->
                <nav class="hidden md:flex space-x-8">
                    <a href="restaurant_browse.html" class="text-text-secondary hover:text-primary transition-smooth">Browse</a>
                    <a href="order_tracking.html" class="text-text-secondary hover:text-primary transition-smooth">Orders</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumb -->
        <div class="mb-6">
            <div class="flex items-center space-x-2 text-sm text-text-secondary">
                <a href="../restaurants/restaurant_browse.html" class="hover:text-primary transition-smooth">Browse</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <a href="shopping_cart.html" class="hover:text-primary transition-smooth">Cart</a>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                <span class="text-text-primary">Checkout</span>
            </div>
        </div>

        <!-- Page Header -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-text-primary mb-2">Checkout</h2>
            <p class="text-text-secondary">Review your order and complete your purchase</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Checkout Form -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Delivery Address -->
                <section class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Delivery Address</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">Select Address</label>
                            <select id="delivery-address-select" class="w-full border border-border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Loading addresses...</option>
                            </select>
                        </div>
                        <button id="addNewAddressBtn" onclick="openMapAddressPicker()" class="text-primary text-sm hover:text-primary-600 transition-smooth flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            <span>Add new address</span>
                        </button>
                        <!-- Barangay Validation Warning -->
                        <div id="barangay-warning" class="hidden p-3 bg-warning-50 border border-warning-200 rounded-lg">
                            <div class="flex items-start space-x-2">
                                <svg class="w-5 h-5 text-warning flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <div class="flex-1">
                                    <div class="text-warning font-medium text-sm mb-1">Delivery Not Available</div>
                                    <div class="text-warning text-xs" id="barangay-warning-text"></div>
                                    <a href="customer_profile.html" class="text-warning underline text-xs mt-1 inline-block">Update your location ‚Üí</a>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 bg-success-50 rounded-lg">
                            <div class="flex items-center space-x-2">
                                <svg class="w-4 h-4 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <span class="text-success text-sm font-medium">Estimated delivery: 30-40 min</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Payment Method -->
                <section class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Payment Method</h3>
                    <div class="space-y-4">
                        <!-- Cash Payment Only -->
                        <div class="border border-primary rounded-lg bg-primary-50">
                            <div class="flex items-center p-4">
                                <input type="radio" name="payment_method" value="cash" checked readonly class="h-5 w-5 text-primary focus:ring-primary border-border">
                                <div class="ml-4 flex-1">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-semibold text-text-primary">Cash on Delivery</h3>
                                            <p class="text-text-secondary">Pay in cash when your order arrives. Delivery rider will show the admin's GCash QR code for payment.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Cash Details -->
                            <div class="mx-4 mb-4 px-4 py-3 bg-green-50 rounded-lg">
                                <p class="text-sm text-green-800">
                                    <strong>Cash Payment Instructions:</strong><br>
                                    ‚Ä¢ Pay the exact amount: ‚Ç±<span id="cash-amount">0.00</span><br>
                                    ‚Ä¢ Prepare exact change if possible<br>
                                    ‚Ä¢ Delivery rider will show admin's GCash QR code<br>
                                    ‚Ä¢ Payment collected by delivery rider upon delivery
                                </p>
                                <div class="mt-3">
                                    <label class="block text-sm font-medium text-green-800 mb-2">Special Instructions (Optional)</label>
                                    <textarea rows="2"
                                              placeholder="Please bring extra change, etc."
                                              class="w-full border border-green-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Order & Delivery Schedule -->
                <section class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Order & Delivery Schedule</h3>
                    <p class="text-sm text-text-secondary mb-4">
                        <em>(Delivery time indicates the start of delivery trips from the Municipality of Claver to different barangays.)</em>
                    </p>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">9:00 AM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïó <strong>Order Time:</strong> 8:00 AM ‚Äì 8:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">10:00 AM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïò <strong>Order Time:</strong> 8:40 AM ‚Äì 9:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">11:00 AM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïô <strong>Order Time:</strong> 9:40 AM ‚Äì 10:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">12:00 noon Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïô <strong>Order Time:</strong> 10:40 AM ‚Äì 11:40 AM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">1:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïõ <strong>Order Time:</strong> 11:40 NN ‚Äì 12:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">2:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïê <strong>Order Time:</strong> 12:40 PM ‚Äì 1:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">3:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïë <strong>Order Time:</strong> 1:40 PM ‚Äì 2:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">4:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïí <strong>Order Time:</strong> 2:40 PM ‚Äì 3:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">5:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïì <strong>Order Time:</strong> 3:40 PM ‚Äì 4:40 PM
                                </div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                            <span class="text-2xl">üì¶</span>
                            <div class="flex-1">
                                <div class="font-semibold text-text-primary">6:00 PM Delivery</div>
                                <div class="text-sm text-text-secondary mt-1">
                                    üïî <strong>Order Time:</strong> 4:40 PM ‚Äì 5:40 PM
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Delivery Instructions -->
                <section class="bg-surface rounded-lg p-6 shadow-card border border-border">
                    <h3 class="text-lg font-semibold text-text-primary mb-4">Delivery Instructions (Optional)</h3>
                    <textarea rows="3" 
                              placeholder="Leave at door, call when arrived, etc." 
                              class="w-full border border-border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
                </section>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-surface rounded-lg shadow-card border border-border sticky top-8">
                    <!-- Restaurant Info -->
                    <div class="p-6 border-b border-border">
                        <div class="flex items-center space-x-3">
                            <img src="https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" 
                                 alt="Pizza Palace" 
                                 class="w-12 h-12 rounded-lg object-cover"
                                 onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                            <div>
                                <h4 class="font-semibold text-text-primary">Pizza Palace</h4>
                                <p class="text-sm text-text-secondary">25-35 min ‚Ä¢ ‚Ç±50.00 delivery</p>
                            </div>
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="p-6 border-b border-border">
                        <h3 class="font-semibold text-text-primary mb-4">Order Summary</h3>
                        <div class="space-y-3">
                            <!-- Order items will be loaded here -->
                        </div>
                    </div>

                    <!-- Price Breakdown -->
                    <div class="p-6">
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Subtotal</span>
                                <span class="text-text-primary">‚Ç±0.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Delivery fee</span>
                                <span class="text-text-primary">‚Ç±50.00</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-text-secondary">Tax</span>
                                <span class="text-text-primary">‚Ç±0.00</span>
                            </div>
                            <div class="border-t border-border pt-2 mt-2">
                                <div class="flex justify-between">
                                    <span class="font-semibold text-text-primary">Total</span>
                                    <span class="font-bold text-text-primary text-lg">‚Ç±0.00</span>
                                </div>
                            </div>
                        </div>

                        <!-- Promo Code -->
                        <div class="mb-4">
                            <input type="text" 
                                   placeholder="Promo code" 
                                   class="w-full border border-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent mb-2">
                            <button class="w-full text-primary text-sm hover:text-primary-600 transition-smooth">Apply promo code</button>
                        </div>

                        <!-- Place Order Button -->
                        <button onclick="placeOrder()" class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-primary-600 transition-smooth btn-hover">
                            Place Order
                        </button>

                        <p class="text-xs text-text-secondary text-center mt-3">By placing your order, you agree to our Terms of Service and Privacy Policy</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-surface border-t border-border mt-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex flex-col sm:flex-row justify-between items-center">
                <p class="text-text-secondary text-sm">¬© 2025 HATOD. All Rights Reserved.</p>
                <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Privacy Policy</a>
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Terms of Service</a>
                    <a href="javascript:void(0)" class="text-text-secondary hover:text-primary transition-smooth text-sm">Support</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="../../public/config.js"></script>
    <script>
        // API base URL (from config.js - automatically uses Railway URL in mobile apps)
        const API_BASE_URL = window.API_BASE_URL;
        <script>
        const API_BASE_URL = window.API_BASE_URL || 'http://localhost:4000/api';

        document.addEventListener('DOMContentLoaded', () => {
            loadCheckoutData();
            // Check if returning from map address picker
            checkForNewAddress();
        });

        // Open map address picker
        function openMapAddressPicker() {
            const callbackUrl = encodeURIComponent(window.location.href);
            window.location.href = `../shared/map_address_picker.html?callback=${callbackUrl}`;
        }

        // Check if returning from map picker with new address
        async function checkForNewAddress() {
            const urlParams = new URLSearchParams(window.location.search);
            const address = urlParams.get('address');
            const lat = urlParams.get('lat');
            const lng = urlParams.get('lng');
            const city = urlParams.get('city');
            const zipCode = urlParams.get('zipCode');
            const apartment = urlParams.get('apartment');
            
            if (address) {
                // Clean up URL first
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // Save the address automatically
                try {
                    const token = localStorage.getItem('authToken');
                    if (!token) {
                        alert('Please log in to save address');
                        return;
                    }

                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const customerId = payload.sub;

                    const addressData = {
                        label: 'Home',
                        streetAddress: decodeURIComponent(address),
                        city: city ? decodeURIComponent(city) : '',
                        zipCode: zipCode ? decodeURIComponent(zipCode) : '',
                        apartment: apartment ? decodeURIComponent(apartment) : null,
                        state: null,
                        latitude: lat ? parseFloat(lat) : null,
                        longitude: lng ? parseFloat(lng) : null,
                        isDefault: false
                    };

                    const response = await fetch(`${API_BASE_URL}/customers/${customerId}/addresses`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(addressData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to save address');
                    }

                    // Reload addresses
                    await reloadAddresses();
                    
                    // Show success message
                    alert('Address added successfully!');
                } catch (error) {
                    console.error('Error saving address:', error);
                    alert('Failed to save address: ' + error.message);
                }
            }
        }

        // Reload addresses
        async function reloadAddresses() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const payload = JSON.parse(atob(token.split('.')[1]));
                const customerId = payload.sub;

                const addressesResponse = await fetch(`${API_BASE_URL}/customers/${customerId}/addresses`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const addressesData = await addressesResponse.json();
                const addresses = addressesData.data || [];

                updateAddressSelection(addresses);
            } catch (error) {
                console.error('Error reloading addresses:', error);
            }
        }

        async function loadCheckoutData() {
            try {
                // Load cart data
                const cartResponse = await fetch(`${API_BASE_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });

                if (!cartResponse.ok) {
                    throw new Error('Failed to load cart');
                }

                const cartData = await cartResponse.json();
                const cart = cartData.data || [];


                if (cart.length === 0) {
                    alert('Your cart is empty');
                    window.location.href = 'shopping_cart.html';
                    return;
                }

                // Load addresses
                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Please log in to continue');
                    window.location.href = '../login.html';
                    return;
                }

                // Decode JWT to get customer ID (simple decode, not secure)
                const payload = JSON.parse(atob(token.split('.')[1]));
                const customerId = payload.sub;

                const addressesResponse = await fetch(`${API_BASE_URL}/customers/${customerId}/addresses`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const addressesData = await addressesResponse.json();
                const addresses = addressesData.data || [];

                // Update UI with real data
                updateRestaurantInfo(cart);
                updateOrderSummary(cart);
                updateAddressSelection(addresses);
                
                // Validate barangay
                await validateBarangay(token, customerId);

            } catch (error) {
                console.error('Error loading checkout data:', error);
                alert('Failed to load checkout data. Please try again.');
            }
        }

        async function validateBarangay(token, customerId) {
            try {
                // Get customer profile to check barangay
                const profileResponse = await fetch(`${API_BASE_URL}/customers/${customerId}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!profileResponse.ok) return;

                const profileData = await profileResponse.json();
                const customerBarangay = profileData.data?.barangay;
                
                if (!customerBarangay) {
                    showBarangayWarning(
                        'Please select your delivery location (barangay) in your profile before placing an order.'
                    );
                    return;
                }

                // Check if barangay is in allowed list
                const allowedBarangaysResponse = await fetch(`${API_BASE_URL}/delivery-fees/tiers`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (allowedBarangaysResponse.ok) {
                    const tiersData = await allowedBarangaysResponse.json();
                    const allowedBarangays = Object.keys(tiersData.data || {});
                    
                    if (allowedBarangays.length > 0 && !allowedBarangays.includes(customerBarangay)) {
                        showBarangayWarning(
                            `Delivery is not available to your selected location (${customerBarangay}). ` +
                            `We currently deliver to: ${allowedBarangays.join(', ')}.`
                        );
                    } else {
                        hideBarangayWarning();
                    }
                }
            } catch (error) {
                console.error('Error validating barangay:', error);
                // Don't block checkout if validation fails, backend will catch it
            }
        }

        function showBarangayWarning(message) {
            const warningDiv = document.getElementById('barangay-warning');
            const warningText = document.getElementById('barangay-warning-text');
            const placeOrderBtn = document.querySelector('button[onclick="placeOrder()"]');
            
            if (warningDiv && warningText) {
                warningText.textContent = message;
                warningDiv.classList.remove('hidden');
            }
            
            // Disable place order button
            if (placeOrderBtn) {
                placeOrderBtn.disabled = true;
                placeOrderBtn.classList.add('opacity-50', 'cursor-not-allowed');
                placeOrderBtn.classList.remove('btn-hover');
            }
        }

        function hideBarangayWarning() {
            const warningDiv = document.getElementById('barangay-warning');
            const placeOrderBtn = document.querySelector('button[onclick="placeOrder()"]');
            
            if (warningDiv) {
                warningDiv.classList.add('hidden');
            }
            
            // Enable place order button
            if (placeOrderBtn) {
                placeOrderBtn.disabled = false;
                placeOrderBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                placeOrderBtn.classList.add('btn-hover');
            }
        }

        function updateRestaurantInfo(cart) {
            if (cart.length === 0) return;

            const firstItem = cart[0];
            const restaurantLogo = document.querySelector('img[alt="Pizza Palace"]');
            const restaurantName = document.querySelector('h4.font-semibold.text-text-primary');
            const deliveryInfo = document.querySelector('p.text-sm.text-text-secondary');

            restaurantLogo.src = firstItem.restaurantImageUrl || restaurantLogo.src;
            restaurantName.textContent = firstItem.restaurantName || 'Restaurant';
            deliveryInfo.textContent = '25-35 min ‚Ä¢ ‚Ç±50 delivery';
        }

        async function updateOrderSummary(cart) {
            const orderItemsContainer = document.querySelector('.space-y-3');

            // Find price elements more reliably
            const priceBreakdown = document.querySelector('.space-y-2');
            const priceElements = priceBreakdown.querySelectorAll('.flex.justify-between.text-sm span:last-child');
            const subtotalElement = priceElements[0]; // Subtotal
            const deliveryFeeElement = priceElements[1]; // Delivery fee
            const taxElement = priceElements[2]; // Tax

            const totalElement = document.querySelector('.border-t.border-border .flex.justify-between span:last-child');

            let orderItemsHtml = '';
            let subtotal = 0;

            cart.forEach(item => {
                const price = parseFloat(item.price) || 0;
                const itemTotal = price * item.quantity;
                subtotal += itemTotal;

                orderItemsHtml += `
                    <div class="flex justify-between text-sm">
                        <span class="text-text-secondary">${item.name} x${item.quantity}</span>
                        <span class="text-text-primary">‚Ç±${itemTotal.toFixed(2)}</span>
                    </div>
                `;
            });

            orderItemsContainer.innerHTML = orderItemsHtml;

            // Calculate delivery fee based on barangay and order amount
            let deliveryFee = 0;
            try {
                const token = localStorage.getItem('authToken');
                if (token) {
                    // Get customer's barangay
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const customerId = payload.sub;

                    const profileResponse = await fetch(`${API_BASE_URL}/customers/${customerId}/profile`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (profileResponse.ok) {
                        const profileData = await profileResponse.json();
                        const barangay = profileData.data?.barangay;

                        if (barangay) {
                            // Calculate delivery fee based on barangay and order amount
                            const feeResponse = await fetch(`${API_BASE_URL}/delivery-fees/calculate`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    barangay: barangay,
                                    orderAmount: subtotal
                                })
                            });

                            if (feeResponse.ok) {
                                const feeData = await feeResponse.json();
                                deliveryFee = parseFloat(feeData.data.deliveryFee) || 0;
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error calculating delivery fee:', error);
                // Fallback to default fee
                deliveryFee = 50;
            }

            const total = subtotal + deliveryFee;

            if (subtotalElement) subtotalElement.textContent = `‚Ç±${subtotal.toFixed(2)}`;
            if (deliveryFeeElement) deliveryFeeElement.textContent = `‚Ç±${deliveryFee.toFixed(2)}`;
            if (taxElement) taxElement.textContent = `‚Ç±0.00`;
            if (totalElement) totalElement.textContent = `‚Ç±${total.toFixed(2)}`;

            // Update cash payment instructions
            const cashAmountElement = document.getElementById('cash-amount');
            if (cashAmountElement) {
                cashAmountElement.textContent = total.toFixed(2);
            }

            // Update delivery info
            const deliveryInfo = document.querySelector('p.text-sm.text-text-secondary');
            if (deliveryInfo) {
                deliveryInfo.textContent = `25-35 min ‚Ä¢ ‚Ç±${deliveryFee.toFixed(2)} delivery`;
            }
        }

        function updateAddressSelection(addresses) {
            const addressSelect = document.getElementById('delivery-address-select') || document.querySelector('select.w-full.border');
            if (addresses.length === 0) {
                addressSelect.innerHTML = '<option>No addresses available</option>';
                return;
            }

            let optionsHtml = '';
            addresses.forEach(address => {
                // Use camelCase properties as returned by API
                const streetAddress = address.streetAddress || '';
                const apartment = address.apartment || '';
                const city = address.city || '';
                const state = address.state || '';
                const zipCode = address.zipCode || '';
                const label = address.label || '';
                
                // Build address string
                let addressParts = [];
                if (streetAddress) addressParts.push(streetAddress);
                if (apartment) addressParts.push(apartment);
                if (city) addressParts.push(city);
                if (state) addressParts.push(state);
                if (zipCode) addressParts.push(zipCode);
                
                const fullAddress = addressParts.length > 0 
                    ? addressParts.join(', ')
                    : (label || 'Address');
                
                optionsHtml += `<option value="${address.id}">${fullAddress}</option>`;
            });

            addressSelect.innerHTML = optionsHtml;
        }

        async function placeOrder() {
            try {
                const addressSelect = document.querySelector('select.w-full.border');
                const specialInstructions = document.querySelector('textarea[placeholder*="Leave at door"]').value;

                if (!addressSelect.value) {
                    alert('Please select a delivery address');
                    return;
                }

                const token = localStorage.getItem('authToken');
                if (!token) {
                    alert('Please log in to continue');
                    window.location.href = '../login.html';
                    return;
                }

                // Validate customer's barangay before placing order
                const payload = JSON.parse(atob(token.split('.')[1]));
                const customerId = payload.sub;
                
                const profileResponse = await fetch(`${API_BASE_URL}/customers/${customerId}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (profileResponse.ok) {
                    const profileData = await profileResponse.json();
                    const customerBarangay = profileData.data?.barangay;
                    
                    if (!customerBarangay) {
                        alert(
                            'Please select your delivery location (barangay) in your profile before placing an order.\n\n' +
                            'Go to your account settings to update your location.'
                        );
                        window.location.href = 'customer_profile.html';
                        return;
                    }

                    // Check if barangay is in allowed list
                    const allowedBarangaysResponse = await fetch(`${API_BASE_URL}/delivery-fees/tiers`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (allowedBarangaysResponse.ok) {
                        const tiersData = await allowedBarangaysResponse.json();
                        const allowedBarangays = Object.keys(tiersData.data || {});
                        
                        if (allowedBarangays.length > 0 && !allowedBarangays.includes(customerBarangay)) {
                            alert(
                                `Delivery is not available to your selected location (${customerBarangay}).\n\n` +
                                `We currently deliver to:\n${allowedBarangays.join(', ')}\n\n` +
                                `Please update your location in your profile to one of the supported barangays.`
                            );
                            window.location.href = 'customer_profile.html';
                            return;
                        }
                    }
                }

                // Get cart data again to ensure we have the latest
                const cartResponse = await fetch(`${API_BASE_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!cartResponse.ok) {
                    throw new Error('Failed to load cart for order');
                }

                const cartData = await cartResponse.json();
                const cart = cartData.data || [];

                if (cart.length === 0) {
                    alert('Your cart is empty');
                    window.location.href = 'shopping_cart.html';
                    return;
                }

                // Get restaurant ID from first cart item
                const restaurantId = cart[0].restaurantId;

                // Convert cart items to order items format
                const items = cart.map(item => ({
                    menuItemId: item.menuItemId,
                    quantity: item.quantity,
                    specialInstructions: item.specialInstructions || null
                }));

                const orderData = {
                    customerId,
                    restaurantId,
                    deliveryAddressId: addressSelect.value,
                    orderType: 'delivery',
                    tipAmount: 0,
                    items,
                    specialInstructions: specialInstructions || null
                };

                const response = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to place order');
                }

                const result = await response.json();
                console.log('Order placed:', result);

                // Clear cart after successful order
                await fetch(`${API_BASE_URL}/cart`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                // Redirect to payment confirmation with order ID
                window.location.href = `payment_confirmation.html?orderId=${result.data.orderId}`;

            } catch (error) {
                console.error('Error placing order:', error);
                alert('Failed to place order: ' + error.message);
            }
        }
    </script>
<script id="dhws-dataInjector" src="../../public/dhws-data-injector.js"></script>
</body>
</html>

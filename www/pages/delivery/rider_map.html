<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Map View - HATOD</title>
    <link rel="stylesheet" href="../../css/main.css">
    <link rel="stylesheet" href="../../css/pages.css">
    <!-- Mapbox GL CSS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <style>
        #map {
            width: 100%;
            height: calc(100vh - calc(4rem + max(2rem, env(safe-area-inset-top))) - calc(5rem + max(2rem, env(safe-area-inset-bottom))));
            min-height: 400px;
        }
        .mapboxgl-popup-content {
            border-radius: 8px;
            padding: 12px;
        }
    </style>
    <style>
        html, body {
            overflow-x: hidden;
            position: relative;
        }
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body class="bg-background min-h-screen">
    <!-- Header Navigation -->
    <header class="fixed top-0 left-0 right-0 bg-surface shadow-card border-b border-border z-50" style="padding-top: max(2rem, env(safe-area-inset-top));">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <img src="../../public/logos/app_logo.png" alt="HATOD Logo" class="w-10 h-10 mr-3 object-contain">
                    <h1 class="text-xl font-bold text-text-primary">HATOD</h1>
                </div>

                <!-- Navigation -->
                <nav class="hidden md:flex space-x-8">
                    <a href="rider_dashboard.html" class="text-text-secondary hover:text-primary transition-smooth">Dashboard</a>
                    <a href="rider_orders.html" class="text-text-secondary hover:text-primary transition-smooth">Orders</a>
                    <a href="rider_map.html" class="text-primary font-medium border-b-2 border-primary pb-1">Map</a>
                    <a href="rider_payment.html" class="text-text-secondary hover:text-primary transition-smooth">Payment</a>
                    <a href="rider_profile.html" class="text-text-secondary hover:text-primary transition-smooth">Profile</a>
                </nav>

                <!-- User Profile -->
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button class="flex items-center space-x-2 text-text-secondary hover:text-primary transition-smooth">
                            <img id="riderProfileImage"
                                 src="../../public/default-avatar.svg"
                                 alt="Rider profile picture"
                                 class="w-8 h-8 rounded-full object-cover"
                                 onerror="this.src=window.DEFAULT_AVATAR_URL || '../../public/default-avatar.svg'; this.onerror=null;"
                                 data-old-onerror="this.src='https://images.unsplash.com/photo-1584824486509-112e4181ff6b?q=80&w=2940&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'; this.onerror=null;">
                            <span id="riderName" class="text-sm font-medium">Loading...</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="relative">
        <!-- Map Container -->
        <div id="map"></div>
    </main>

    <!-- Mobile Bottom Tab Navigation -->
    <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-surface border-t border-border shadow-lg z-40" style="padding-bottom: max(2rem, env(safe-area-inset-bottom));">
        <div class="flex items-center justify-around py-2 px-4">
            <a href="rider_dashboard.html" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors">
                <svg class="w-6 h-6 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <span class="text-xs font-medium text-text-secondary">Dashboard</span>
            </a>
            <a href="rider_orders.html" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors">
                <svg class="w-6 h-6 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <span class="text-xs font-medium text-text-secondary">Orders</span>
            </a>
            <a href="rider_map.html" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors active-tab">
                <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                </svg>
                <span class="text-xs font-medium text-primary">Map</span>
            </a>
            <a href="rider_profile.html" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors">
                <svg class="w-6 h-6 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span class="text-xs font-medium text-text-secondary">Profile</span>
            </a>
            <a href="rider_payment.html" class="flex flex-col items-center space-y-1 p-2 rounded-lg transition-colors">
                <svg class="w-6 h-6 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                <span class="text-xs font-medium text-text-secondary">Payment</span>
            </a>
        </div>
    </nav>

    <!-- Mapbox GL JS -->
    <script src="../../public/config.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
        const API_BASE_URL = window.API_BASE_URL || 'http://localhost:4000/api';
        mapboxgl.accessToken = 'pk.eyJ1Ijoia3JpZGxsbCIsImEiOiJjbWljdzdmYXUwb3I1MmpwcTJyNWVsN252In0.2lBD_f8wyFrpViRg8n6cOw';

        let map;
        let markers = [];
        let riderMarker = null;
        let locationWatchId = null;
        let lastLocationUpdate = null;
        const LOCATION_UPDATE_INTERVAL = 5000; // Update location every 5 seconds
        const LOCATION_SEND_INTERVAL = 10000; // Send to server every 10 seconds
        
        // Check if running in Capacitor (mobile app) or browser
        const isCapacitorEnv = window.Capacitor !== undefined;
        let GeolocationAPI = null;
        
        // Load Capacitor Geolocation plugin if available
        (async function() {
            if (isCapacitorEnv) {
                try {
                    // Try to access via Capacitor.Plugins first
                    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Geolocation) {
                        GeolocationAPI = window.Capacitor.Plugins.Geolocation;
                    } else {
                        // Try dynamic import
                        const { Geolocation } = await import('@capacitor/geolocation');
                        GeolocationAPI = Geolocation;
                    }
                } catch (error) {
                    console.warn('Capacitor Geolocation plugin not available, falling back to browser API:', error);
                }
            }
        })();

        function getAuthToken() {
            return localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        }

        // Function to get user ID from token
        function getUserId() {
            const token = getAuthToken();
            if (!token) return null;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.sub;
            } catch (e) {
                return null;
            }
        }

        async function apiCall(endpoint, options = {}) {
            const token = getAuthToken();
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                }
            };

            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            });

            if (!response.ok) {
                throw new Error(`API call failed: ${response.status}`);
            }

            return response.json();
        }

        // Initialize map
        function initMap() {
            // Default center (you can set this to your service area center)
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [125.5, 9.8], // Default coordinates (adjust to your area)
                zoom: 12
            });

            // Add navigation controls
            map.addControl(new mapboxgl.NavigationControl(), 'top-right');

            // Start real-time location tracking
            startLocationTracking();
        }

        // Request location permissions (for Capacitor)
        async function requestLocationPermissions() {
            // Wait for GeolocationAPI to be loaded if in Capacitor
            if (isCapacitorEnv && !GeolocationAPI) {
                // Wait a bit for the async import to complete
                await new Promise(resolve => setTimeout(resolve, 100));
                if (!GeolocationAPI) {
                    // Try direct access via Capacitor.Plugins
                    if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Geolocation) {
                        GeolocationAPI = window.Capacitor.Plugins.Geolocation;
                    }
                }
            }
            
            if (!GeolocationAPI) return true; // Browser will handle permissions
            
            try {
                const permissionStatus = await GeolocationAPI.checkPermissions();
                if (permissionStatus.location === 'granted') {
                    return true;
                }
                
                const requestResult = await GeolocationAPI.requestPermissions();
                return requestResult.location === 'granted';
            } catch (error) {
                console.error('Error requesting location permissions:', error);
                return false;
            }
        }

        // Start continuous location tracking
        async function startLocationTracking() {
            // Check if geolocation is available
            const hasGeolocation = GeolocationAPI || navigator.geolocation;
            if (!hasGeolocation) {
                console.error('Geolocation is not supported');
                alert('Location services are not available on this device.');
                return;
            }

            // Request permissions if using Capacitor
            if (isCapacitorEnv && GeolocationAPI) {
                const hasPermission = await requestLocationPermissions();
                if (!hasPermission) {
                    alert('Location permission is required to track your movement. Please enable location access in your device settings.');
                    return;
                }
            }

            // Options for location tracking
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            try {
                // Get initial position
                let initialPosition;
                if (isCapacitorEnv && GeolocationAPI) {
                    // Use Capacitor Geolocation
                    initialPosition = await GeolocationAPI.getCurrentPosition(options);
                } else {
                    // Use browser Geolocation (fallback)
                    initialPosition = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, options);
                    });
                }

                const { longitude, latitude } = initialPosition.coords;
                map.setCenter([longitude, latitude]);
                map.setZoom(14);
                updateRiderMarker(longitude, latitude);
                sendLocationToServer(latitude, longitude);

                // Watch position for continuous updates
                if (isCapacitorEnv && GeolocationAPI) {
                    // Use Capacitor watchPosition
                    locationWatchId = await GeolocationAPI.watchPosition(options, (position, err) => {
                        if (err) {
                            console.error('Error watching location:', err);
                            if (err.message && err.message.includes('permission')) {
                                alert('Location permission denied. Please enable location access to track your movement.');
                            }
                            return;
                        }
                        
                        const { longitude, latitude } = position.coords;
                        const now = Date.now();
                        
                        // Update marker position on map
                        updateRiderMarker(longitude, latitude);
                        
                        // Send location to server periodically
                        if (!lastLocationUpdate || (now - lastLocationUpdate) >= LOCATION_SEND_INTERVAL) {
                            sendLocationToServer(latitude, longitude);
                            lastLocationUpdate = now;
                        }
                    });
                } else {
                    // Use browser watchPosition (fallback)
                    locationWatchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const { longitude, latitude } = position.coords;
                            const now = Date.now();
                            
                            // Update marker position on map
                            updateRiderMarker(longitude, latitude);
                            
                            // Send location to server periodically
                            if (!lastLocationUpdate || (now - lastLocationUpdate) >= LOCATION_SEND_INTERVAL) {
                                sendLocationToServer(latitude, longitude);
                                lastLocationUpdate = now;
                            }
                        },
                        (error) => {
                            console.error('Error watching location:', error);
                            if (error.code === error.PERMISSION_DENIED) {
                                alert('Location permission denied. Please enable location access to track your movement.');
                            }
                        },
                        options
                    );
                }
            } catch (error) {
                console.error('Error getting initial location:', error);
                if (error.message && error.message.includes('permission')) {
                    alert('Location permission is required. Please enable location access in your device settings.');
                } else {
                    alert('Failed to get your location. Please check your location settings.');
                }
            }
        }

        // Update rider marker position on map
        function updateRiderMarker(longitude, latitude) {
            if (!riderMarker) {
                // Create rider marker if it doesn't exist
                const el = document.createElement('div');
                el.className = 'rider-location-marker';
                el.style.width = '20px';
                el.style.height = '20px';
                el.style.borderRadius = '50%';
                el.style.backgroundColor = '#3B82F6';
                el.style.border = '3px solid white';
                el.style.boxShadow = '0 2px 8px rgba(0,0,0,0.4)';
                el.style.cursor = 'pointer';
                
                riderMarker = new mapboxgl.Marker(el)
                    .setLngLat([longitude, latitude])
                    .setPopup(new mapboxgl.Popup().setHTML('<strong>Your Current Location</strong><br><small>Real-time tracking active</small>'))
                    .addTo(map);
            } else {
                // Update existing marker position with smooth animation
                riderMarker.setLngLat([longitude, latitude]);
            }
        }

        // Send location update to server
        async function sendLocationToServer(latitude, longitude) {
            try {
                await apiCall('/delivery/riders/location', {
                    method: 'POST',
                    body: JSON.stringify({ latitude, longitude })
                });
            } catch (error) {
                console.error('Error sending location to server:', error);
                // Don't show error to user - location tracking should be silent
            }
        }

        // Stop location tracking (cleanup)
        async function stopLocationTracking() {
            if (locationWatchId !== null) {
                if (isCapacitorEnv && GeolocationAPI) {
                    // Use Capacitor clearWatch
                    await GeolocationAPI.clearWatch({ id: locationWatchId });
                } else {
                    // Use browser clearWatch (fallback)
                    navigator.geolocation.clearWatch(locationWatchId);
                }
                locationWatchId = null;
            }
        }

        // Load active deliveries and display on map
        async function loadDeliveries() {
            try {
                // Fetch both assigned deliveries and available orders
                const [assignmentsData, availableData] = await Promise.all([
                    apiCall('/delivery/riders/assignments?status=all').catch(() => ({ data: [] })),
                    apiCall('/delivery/available-orders').catch(() => ({ data: [] }))
                ]);
                
                const assignedDeliveries = assignmentsData.data || [];
                const availableOrders = availableData.data || [];
                
                // Filter for active deliveries
                const activeDeliveries = assignedDeliveries.filter(d => 
                    ['assigned', 'picked_up', 'en_route'].includes(d.status)
                );

                // Mark available orders as unassigned
                const allDeliveries = [
                    ...activeDeliveries.map(d => ({ ...d, isAvailable: false })),
                    ...availableOrders.map(d => ({ ...d, isAvailable: true, status: 'available' }))
                ];

                // Clear existing markers
                markers.forEach(marker => marker.remove());
                markers = [];

                // Add markers to map for delivery addresses and restaurants
                allDeliveries.forEach(delivery => {
                    // Add restaurant marker using restaurant logo
                    if (delivery.restaurantLatitude && delivery.restaurantLongitude) {
                        const API_ORIGIN = API_BASE_URL.replace(/\/api$/, '');
                        const DEFAULT_RESTAURANT_IMAGE = window.DEFAULT_AVATAR_URL || `${API_ORIGIN}/public/default-avatar.svg`;
                        
                        // Resolve restaurant image URL
                        let restaurantImageUrl = DEFAULT_RESTAURANT_IMAGE;
                        if (delivery.restaurantImageUrl) {
                            if (delivery.restaurantImageUrl.startsWith('http://') || delivery.restaurantImageUrl.startsWith('https://')) {
                                restaurantImageUrl = delivery.restaurantImageUrl;
                            } else {
                                const path = delivery.restaurantImageUrl.startsWith('/') ? delivery.restaurantImageUrl : `/${delivery.restaurantImageUrl}`;
                                restaurantImageUrl = `${API_ORIGIN}${path}`;
                            }
                        }
                        
                        // Create restaurant marker with logo
                        const restaurantEl = document.createElement('div');
                        restaurantEl.className = 'restaurant-marker';
                        restaurantEl.style.width = '48px';
                        restaurantEl.style.height = '48px';
                        restaurantEl.style.borderRadius = '50%';
                        restaurantEl.style.border = '3px solid white';
                        restaurantEl.style.cursor = 'pointer';
                        restaurantEl.style.boxShadow = '0 2px 8px rgba(0,0,0,0.4)';
                        restaurantEl.style.overflow = 'hidden';
                        restaurantEl.style.backgroundColor = '#10B981'; // Fallback background color
                        restaurantEl.style.display = 'flex';
                        restaurantEl.style.alignItems = 'center';
                        restaurantEl.style.justifyContent = 'center';
                        
                        // Create image element for restaurant logo
                        const restaurantImg = document.createElement('img');
                        restaurantImg.src = restaurantImageUrl;
                        restaurantImg.alt = delivery.restaurantName || 'Restaurant';
                        restaurantImg.style.width = '100%';
                        restaurantImg.style.height = '100%';
                        restaurantImg.style.objectFit = 'cover';
                        restaurantImg.style.borderRadius = '50%';
                        
                        // Fallback to default icon if image fails to load
                        restaurantImg.onerror = function() {
                            this.style.display = 'none';
                            restaurantEl.innerHTML = '<span style="color: white; font-size: 20px;">üìç</span>';
                            restaurantEl.style.backgroundColor = '#10B981';
                        };
                        
                        restaurantEl.appendChild(restaurantImg);

                        const restaurantMarker = new mapboxgl.Marker(restaurantEl)
                            .setLngLat([delivery.restaurantLongitude, delivery.restaurantLatitude])
                            .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`
                                <div class="p-2">
                                    <strong class="text-green-600">üìç ${delivery.restaurantName || 'Restaurant'}</strong><br>
                                    <span class="text-xs text-gray-600">${delivery.restaurantAddress || 'N/A'}</span><br>
                                    <span class="text-xs text-green-600 font-semibold">Pickup Location</span><br>
                                    <span class="text-xs text-gray-500">Order #${delivery.orderId ? delivery.orderId.slice(-6) : 'N/A'}</span>
                                </div>
                            `))
                            .addTo(map);
                        
                        markers.push(restaurantMarker);
                    }

                    // Add delivery address marker with customer icon
                    const lat = delivery.deliveryLatitude || delivery.latitude;
                    const lng = delivery.deliveryLongitude || delivery.longitude;
                    
                    if (lat && lng) {
                        const statusColor = getStatusColor(delivery.status, delivery.isAvailable);
                        const el = document.createElement('div');
                        el.className = 'delivery-marker';
                        el.style.width = '40px';
                        el.style.height = '40px';
                        el.style.borderRadius = '50%';
                        el.style.backgroundColor = statusColor;
                        el.style.border = '3px solid white';
                        el.style.cursor = 'pointer';
                        el.style.boxShadow = '0 2px 6px rgba(0,0,0,0.4)';
                        el.style.display = 'flex';
                        el.style.alignItems = 'center';
                        el.style.justifyContent = 'center';
                        
                        // Customer icon SVG
                        el.innerHTML = `
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z" fill="white"/>
                                <path d="M12 14C7.58172 14 4 15.7909 4 18V20H20V18C20 15.7909 16.4183 14 12 14Z" fill="white"/>
                            </svg>
                        `;

                        const popupContent = delivery.isAvailable ? `
                            <div class="p-2">
                                <strong>Order #${delivery.orderId ? delivery.orderId.slice(-6) : 'N/A'}</strong><br>
                                <span class="text-sm">${delivery.customerName || 'N/A'}</span><br>
                                <span class="text-xs text-gray-600">${delivery.streetAddress || 'N/A'}</span><br>
                                ${delivery.apartment ? `<span class="text-xs text-gray-600">${delivery.apartment}</span><br>` : ''}
                                <span class="text-xs text-gray-600">${delivery.city || ''}, ${delivery.zipCode || ''}</span><br>
                                <span class="text-xs text-orange-600 font-semibold">Available to Claim</span><br>
                                <a href="rider_order_details.html?deliveryId=${delivery.id}&orderId=${delivery.orderId}" 
                                   class="text-primary text-xs mt-2 inline-block">View Details</a>
                            </div>
                        ` : `
                            <div class="p-2">
                                <strong>Order #${delivery.orderId ? delivery.orderId.slice(-6) : 'N/A'}</strong><br>
                                <span class="text-sm">${delivery.customerName || 'N/A'}</span><br>
                                <span class="text-xs text-gray-600">${delivery.streetAddress || 'N/A'}</span><br>
                                ${delivery.apartment ? `<span class="text-xs text-gray-600">${delivery.apartment}</span><br>` : ''}
                                <span class="text-xs text-gray-600">${delivery.city || ''}, ${delivery.zipCode || ''}</span><br>
                                <span class="text-xs text-primary">Delivery Location</span><br>
                                <a href="rider_order_details.html?deliveryId=${delivery.id}&orderId=${delivery.orderId}" 
                                   class="text-primary text-xs mt-2 inline-block">View Details</a>
                            </div>
                        `;

                        const marker = new mapboxgl.Marker(el)
                            .setLngLat([lng, lat])
                            .setPopup(new mapboxgl.Popup().setHTML(popupContent))
                            .addTo(map);
                        
                        markers.push(marker);
                    }
                });

            } catch (error) {
                console.error('Error loading deliveries:', error);
            }
        }

        function getStatusInfo(status, isAvailable = false) {
            if (isAvailable) {
                return { label: 'Available', class: 'bg-orange-100 text-orange-800' };
            }
            const statusMap = {
                'assigned': { label: 'Assigned', class: 'bg-blue-100 text-blue-800' },
                'picked_up': { label: 'Picked Up', class: 'bg-purple-100 text-purple-800' },
                'en_route': { label: 'En Route', class: 'bg-indigo-100 text-indigo-800' }
            };
            return statusMap[status] || { label: status, class: 'bg-gray-100 text-gray-800' };
        }

        function getStatusColor(status, isAvailable = false) {
            if (isAvailable) {
                return '#F97316'; // Orange for available orders
            }
            const colorMap = {
                'assigned': '#3B82F6',
                'picked_up': '#A855F7',
                'en_route': '#6366F1'
            };
            return colorMap[status] || '#6B7280';
        }

        function focusDelivery(deliveryId, lat, lng) {
            if (lat && lng) {
                map.flyTo({
                    center: [lng, lat],
                    zoom: 15
                });
            }
        }

        function focusRestaurant(lat, lng) {
            if (lat && lng) {
                map.flyTo({
                    center: [lng, lat],
                    zoom: 15
                });
            }
        }

        window.focusDelivery = focusDelivery;
        window.focusRestaurant = focusRestaurant;

        // Load rider profile for header
        async function loadRiderProfile() {
            try {
                const riderId = getUserId();
                if (!riderId) return;

                const token = getAuthToken();
                if (!token) return;

                const response = await fetch(`${API_BASE_URL}/delivery/riders/${riderId}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const rider = result.data;
                    
                    const API_ORIGIN = API_BASE_URL.replace(/\/api$/, '');
                    const PLACEHOLDER_IMAGE = window.DEFAULT_AVATAR_URL || `${API_ORIGIN}/public/default-avatar.svg`;
                    
                    // Update rider name
                    const riderNameEl = document.getElementById('riderName');
                    if (riderNameEl) {
                        riderNameEl.textContent = rider.fullName || 'Rider';
                    }
                    
                    // Update profile image
                    const profileImageEl = document.getElementById('riderProfileImage');
                    if (profileImageEl) {
                        if (rider.imageUrl) {
                            let imageUrl = rider.imageUrl;
                            if (!imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
                                const path = imageUrl.startsWith('/') ? imageUrl : `/${imageUrl}`;
                                imageUrl = `${API_ORIGIN}${path}`;
                            }
                            profileImageEl.src = imageUrl;
                        } else {
                            profileImageEl.src = PLACEHOLDER_IMAGE;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading rider profile:', error);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            map.on('load', () => {
                loadDeliveries();
            });
            
            // Refresh deliveries every 30 seconds
            setInterval(loadDeliveries, 30000);
            
            // Load rider profile
            loadRiderProfile();
        });

        // Cleanup location tracking when page is unloaded
        window.addEventListener('beforeunload', () => {
            stopLocationTracking();
        });
    </script>
    <script id="dhws-dataInjector" src="../../public/dhws-data-injector.js"></script>
</body>
</html>



